<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App TDAH</title>
  <link rel="stylesheet" href="css/styles1.css">

  <!-- Firebase SDKs: Cargados como scripts tradicionales para asegurar que 'firebase' estÃ© disponible globalmente -->
  <!-- CAMBIO AQUÃ: Usando las versiones compat para compatibilidad global -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- Analytics SDK (si lo necesitas, pero no es esencial para el funcionamiento principal) -->
  <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script> -->

  <!-- Script de inicializaciÃ³n de Firebase y autenticaciÃ³n -->
  <script>
    // ConfiguraciÃ³n de Firebase proporcionada por el usuario
    const firebaseConfig = {
        apiKey: "AIzaSyAaC7FvY_9bDHBvl36YWAIIO9qXyvqZrUw",
        authDomain: "tdah-app-efca9.firebaseapp.com",
        projectId: "tdah-app-efca9",
        storageBucket: "tdah-app-efca9.firebasestorage.app",
        messagingSenderId: "765424031369",
        appId: "1:765424031369:web:838eca686f68f21daa5858",
        measurementId: "G-QY7X98XZZV"
    };

    // Inicializar Firebase y exponer a window para main.js
    // Usamos las funciones modulares directamente de Firebase SDK v9
    window.firebaseApp = firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore(); // Usar firebase.firestore() para la compatibilidad global
    window.auth = firebase.auth();   // Usar firebase.auth() para la compatibilidad global

    // Asegurarse de que window.appId estÃ© disponible
    window.appId = firebaseConfig.appId;
    window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; // Mantener para el entorno Canvas

    // Funciones globales que main.js tambiÃ©n podrÃ­a necesitar o que el HTML llama directamente
    // Definirlas aquÃ­ para asegurar que estÃ©n disponibles cuando DOMContentLoaded se dispare.
    window.mostrarSeccion = function(idSeccion) {
        console.log(`Intentando mostrar secciÃ³n: ${idSeccion}`);
        document.querySelectorAll('.seccion').forEach(seccion => {
            seccion.classList.remove('active');
        });
        document.querySelectorAll('.nav-tabs button').forEach(button => {
            button.classList.remove('active');
        });

        const seccionActiva = document.getElementById(idSeccion);
        if (seccionActiva) {
            seccionActiva.classList.add('active');
            console.log(`SecciÃ³n ${idSeccion} activada.`);
        } else {
            console.warn(`SecciÃ³n con ID ${idSeccion} no encontrada.`);
        }
        const botonActivo = document.getElementById(`btn-${idSeccion}`);
        if (botonActivo) {
            botonActivo.classList.add('active');
            console.log(`BotÃ³n con ID btn-${idSeccion} activado.`);
        } else {
            console.warn(`BotÃ³n con ID btn-${idSeccion} no encontrado.`);
        }
    };

    window.showTempMessage = function(message, type = 'info', duration = 3000) {
        console.log(`Mostrar mensaje temporal: [${type}] ${message}`);
        const tempMessageContainer = document.getElementById('temp-message-container');
        if (!tempMessageContainer) {
            console.error("Contenedor de mensajes temporales no encontrado.");
            return;
        }
        const msgElement = document.createElement('div');
        msgElement.className = `temp-message ${type}`;
        msgElement.textContent = message;
        tempMessageContainer.appendChild(msgElement);

        msgElement.offsetHeight;
        msgElement.classList.add('show');

        setTimeout(() => {
            msgElement.classList.remove('show');
            msgElement.classList.add('hide');
            msgElement.addEventListener('transitionend', () => msgElement.remove(), { once: true });
        }, duration);
    };

    window.showCustomConfirm = function(message) {
        return new Promise((resolve) => {
            const modalHtml = `
                <div id="custom-confirm-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 10001;">
                    <div style="background: white; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 400px; width: 90%;">
                        <p style="margin-bottom: 20px; font-size: 1.1em; color: #333;">${message}</p>
                        <button id="confirm-yes" style="background: #4F46E5; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">SÃ­</button>
                        <button id="confirm-no" style="background: #ef4444; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">No</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('custom-confirm-modal');
            document.getElementById('confirm-yes').onclick = () => {
                modal.remove();
                resolve(true);
            };
            document.getElementById('confirm-no').onclick = () => {
                modal.remove();
                resolve(false);
            };
        });
    };


    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded: DOM completamente cargado. Iniciando autenticaciÃ³n Firebase...");

        // Adjuntar event listeners a los botones de navegaciÃ³n
        document.getElementById('btn-pomodoro').addEventListener('click', () => window.mostrarSeccion('pomodoro'));
        document.getElementById('btn-tareas').addEventListener('click', () => window.mostrarSeccion('tareas'));
        document.getElementById('btn-checklist').addEventListener('click', () => window.mostrarSeccion('checklist'));
        document.getElementById('btn-journal').addEventListener('click', () => window.mostrarSeccion('journal'));
        document.getElementById('btn-notas').addEventListener('click', () => window.mostrarSeccion('notas'));
        document.getElementById('btn-nutricion').addEventListener('click', () => window.mostrarSeccion('nutricion'));
        document.getElementById('btn-habitos').addEventListener('click', () => window.mostrarSeccion('habitos')); // Nuevo listener para HÃ¡bitos
        document.getElementById('btn-config').addEventListener('click', () => window.mostrarSeccion('config'));
        console.log("DOMContentLoaded: Event listeners de navegaciÃ³n adjuntados.");

        // Manejar la autenticaciÃ³n
        window.auth.onAuthStateChanged(async (user) => {
            console.log("onAuthStateChanged: Estado de autenticaciÃ³n cambiado.");
            const userIdDisplay = document.getElementById('user-id-display');
            const logoutBtn = document.getElementById('logout-btn');
            const authOptionsArea = document.getElementById('auth-options-area'); // Nuevo elemento para opciones de autenticaciÃ³n

            if (user) {
                window.currentUserId = user.uid;
                console.log("onAuthStateChanged: Usuario autenticado. UID:", window.currentUserId);
                if (userIdDisplay) {
                    userIdDisplay.textContent = `ID de Usuario: ${window.currentUserId}`;
                    userIdDisplay.style.display = 'block'; // Asegurarse de que sea visible
                }
                if (logoutBtn) {
                    logoutBtn.style.display = 'block'; // Mostrar botÃ³n de cerrar sesiÃ³n
                }
                if (authOptionsArea) {
                    authOptionsArea.style.display = 'none'; // Ocultar opciones de inicio de sesiÃ³n
                }
                // Solo cargar datos del usuario si no estamos en medio de un proceso de cierre de sesiÃ³n
                // La variable `isLoggingOut` se manejarÃ¡ en main.js
                if (typeof window.loadAllUserData === 'function') {
                    window.loadAllUserData();
                } else {
                    console.error("loadAllUserData no estÃ¡ definida globalmente.");
                }
            } else { // Usuario es null (no autenticado)
                window.currentUserId = null; // Limpiar ID de usuario actual
                console.log("onAuthStateChanged: Usuario no autenticado.");
                if (userIdDisplay) {
                    userIdDisplay.textContent = 'No autenticado'; // Mostrar texto de no autenticado
                    userIdDisplay.style.display = 'none'; // Ocultar ID de usuario si no estÃ¡ logueado
                }
                if (logoutBtn) {
                    logoutBtn.style.display = 'none'; // Ocultar botÃ³n de cerrar sesiÃ³n
                }
                if (authOptionsArea) {
                    authOptionsArea.style.display = 'flex'; // Mostrar opciones de inicio de sesiÃ³n
                }

                // Si no estamos en medio de un cierre de sesiÃ³n explÃ­cito, intentar inicio de sesiÃ³n anÃ³nimo
                // La variable `isLoggingOut` se manejarÃ¡ en main.js
                if (!window.isLoggingOut) { // Usar window.isLoggingOut ya que es global
                    try {
                        if (window.initialAuthToken) {
                            console.log("onAuthStateChanged: Usando initialAuthToken.");
                            await window.auth.signInWithCustomToken(window.initialAuthToken);
                        } else {
                            console.log("onAuthStateChanged: Usando signInAnonymously.");
                            await window.auth.signInAnonymously();
                        }
                        console.log("onAuthStateChanged: signInAnonymously/CustomToken exitoso.");
                    } catch (error) {
                        console.error("onAuthStateChanged: Error al iniciar sesiÃ³n en Firebase:", error);
                        window.showTempMessage(`Error de autenticaciÃ³n: ${error.message}`, 'error');
                    }
                } else {
                    window.isLoggingOut = false; // Resetear la bandera despuÃ©s de manejar el estado de cierre de sesiÃ³n
                }
            }
        });

        // Inicializar la primera secciÃ³n visible al cargar la pÃ¡gina
        window.mostrarSeccion('pomodoro');
        console.log("DOMContentLoaded: SecciÃ³n Pomodoro inicializada como activa.");

    });
  </script>

</head>
<body>
  <div class="container">

    <header>
      <h1>ğŸ§  TDAH Helper App</h1>
      <p>Tu asistente personal para organizaciÃ³n y productividad</p>
      <div id="user-info-area">
        <div id="user-id-display" style="font-size: 0.8em; color: var(--text-light); margin-top: 10px;">Cargando usuario...</div>
        <button id="logout-btn" class="auth-btn" style="display: none;">Cerrar SesiÃ³n</button> <!-- Oculto por defecto -->
        
        <!-- Opciones de autenticaciÃ³n, ocultas por defecto -->
        <div id="auth-options-area" style="display: none; flex-direction: column; gap: 10px; margin-top: 10px; width: 100%;">
            <p style="color: var(--text-medium); font-size: 0.9em; margin: 0;">Inicia sesiÃ³n para guardar tus datos:</p>
            <button id="login-anon-btn" class="auth-btn">Iniciar SesiÃ³n AnÃ³nima</button>
            <button id="login-email-btn" class="auth-btn" style="background: #DB4437;">Iniciar SesiÃ³n con Email</button>
            <button id="login-google-btn" class="auth-btn" style="background: #4285F4;">Iniciar SesiÃ³n con Google</button>
        </div>
      </div>
    </header>

    <div class="nav-tabs">
      <button id="btn-pomodoro" class="active">â±ï¸ Pomodoro</button>
      <button id="btn-tareas">ğŸ“‹ Tareas Importantes</button>
      <button id="btn-checklist">âœ… Checklist RÃ¡pido</button>
      <button id="btn-journal">ğŸ“ Journal</button>
      <button id="btn-notas">ğŸ“ Notas Blog</button>
      <button id="btn-nutricion">ğŸ NutriciÃ³n</button>
      <button id="btn-habitos">âœ… HÃ¡bitos</button> <!-- Nuevo botÃ³n de navegaciÃ³n con icono y mayÃºscula -->
      <button id="btn-config">âš™ï¸ ConfiguraciÃ³n</button>
    </div>

    <section id="pomodoro" class="seccion active">
      <h2>â±ï¸ Temporizador Pomodoro</h2>
      <div id="timer">25:00</div>
      <div class="pomodoro-buttons">
        <button id="start-timer-btn">â–¶ï¸ Iniciar</button>
        <button id="pause-pomodoro-btn">â¸ï¸ Pausar</button>
        <button id="reset-timer-btn">ğŸ”„ Resetear</button>
      </div>
      <div class="help-text">
        ğŸ’¡ 25 min de trabajo concentrado + 5 min de descanso. Â¡Perfecto para TDAH!
      </div>
    </section>

    <section id="tareas" class="seccion">
      <h2>ğŸ“‹ Tareas Importantes (Trello)</h2>
      <div id="trello-status" class="status-indicator status-disconnected">
        âŒ Trello no conectado
      </div>
      <div id="tareas-content">
        <p>Configura tu conexiÃ³n a Trello para ver las tareas que vencen hoy.</p>
        <button id="config-trello-btn">âš™ï¸ Configurar Trello</button>
      </div>
      <ul id="listaTareas"></ul>
    </section>

    <section id="checklist" class="seccion">
      <h2>âœ… Checklist RÃ¡pido</h2>
      <div class="input-group">
        <input type="text" id="checkItem" placeholder="Nuevo Ã­tem del checklist..." />
        <button id="add-check-item-btn">â• Agregar</button>
      </div>
      <ul id="checkList"></ul>
      <div class="help-text">
        ğŸ’¡ Para tareas pequeÃ±as y recordatorios rÃ¡pidos del dÃ­a
      </div>
       <div class="mit-explanation">
            <strong>MITs (Most Important Tasks):</strong> Puedes marcar hasta 3 tareas como MITs. Estas son las tareas mÃ¡s importantes del dÃ­a que te ayudarÃ¡n a mantener el enfoque en lo esencial.
        </div>
    </section>

    <section id="journal" class="seccion">
        <h2>ğŸ“ Journal</h2>
        <p class="subtitle">Un espacio reflexivo para documentar emociones, actividades y situaciones significativas de tu jornada, fomentando el autoconocimiento y el bienestar.</p>
        <textarea id="journalEntry" rows="10" placeholder="Escribe aquÃ­ tu entrada del diario..."></textarea>
        <button id="save-journal-entry-btn">Guardar Entrada</button>

        <h3>Entradas Anteriores:</h3>
        <ul id="journalEntriesList">
            <!-- Las entradas del diario se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
        </ul>
    </section>

    <section id="notas" class="seccion">
      <h2>ğŸ“ Notas de Blog TDAH</h2>
      <div id="blog-content">
        <p>Cargando artÃ­culos sobre TDAH...</p>
        </div>
      <button id="refresh-blog-btn">ğŸ”„ Actualizar ArtÃ­culos</button>
    </section>

    <section id="nutricion" class="seccion">
        <h2>ğŸ NutriciÃ³n y Recetas</h2>
        <div id="nutricion-content">
            <p>Cargando recomendaciones nutricionales y recetas...</p>
            </div>
        <button id="refresh-nutricion-btn">ğŸ”„ Actualizar Contenido</button>
    </section>

    <!-- Nueva secciÃ³n de HÃ¡bitos -->
    <section id="habitos" class="seccion">
      <h2>âœ… HÃ¡bitos Diarios</h2> <!-- TÃ­tulo de la secciÃ³n con icono y mayÃºscula -->
      <p class="subtitle">Registra y sigue tus hÃ¡bitos diarios para construir rutinas saludables y mantener un registro de tu progreso.</p>
      <div class="input-group">
        <input type="text" id="newHabitInput" placeholder="AÃ±adir nuevo hÃ¡bito..." />
        <button id="add-habit-btn">â• AÃ±adir HÃ¡bito</button>
      </div>
      <ul id="habitsList">
        <!-- Los hÃ¡bitos se cargarÃ¡n aquÃ­ dinÃ¡micamente -->
      </ul>
      <div class="help-text">
        ğŸ’¡ Marca el cÃ­rculo para indicar que completaste el hÃ¡bito hoy.
      </div>
    </section>

    <section id="config" class="seccion">
      <h2>âš™ï¸ ConfiguraciÃ³n</h2>
      
      <div class="config-card" id="config-card">
        <h3>ğŸ”— Conectar con Trello</h3>
        
        <div class="config-step">
          <label for="api-key">API Key de Trello:</label>
          <input type="text" id="api-key" placeholder="Pega aquÃ­ tu API Key...">
          <div class="help-text">
            ğŸ“ ObtÃ©n tu API Key en: <a href="https://trello.com/app-key" target="_blank">https://trello.com/app-key</a>
          </div>
        </div>

        <div class="config-step">
          <label for="token">Token de Trello:</label>
          <input type="text" id="token" placeholder="Pega aquÃ­ tu Token...">
          <div class="help-text">
            ğŸ“ Genera tu Token clickeando en el link que aparece junto a tu API Key
          </div>
        </div>

        <div class="config-step">
          <label for="board-id">ID del Board:</label>
          <input type="text" id="board-id" placeholder="ID de tu board de Trello...">
          <div class="help-text">
            ğŸ“ Encuentra el ID en la URL de tu board: trello.com/b/<strong>ID_AQUI</strong>/nombre-board
          </div>
        </div>

        <button id="test-trello-btn">ğŸ” Probar ConexiÃ³n</button>
        <button id="save-trello-config-btn">ğŸ’¾ Guardar ConfiguraciÃ³n</button>
        
        <div class="success-message" id="trello-success-message">
          âœ… Â¡ConexiÃ³n exitosa! Ya puedes ver tus tareas de Trello.
        </div>
      </div>

      <div class="config-card">
        <h3>ğŸ“Š Estado de la App</h3>
        <p><strong>Tareas guardadas:</strong> <span id="tasks-count">0</span></p>
        <p><strong>Checklist items:</strong> <span id="checklist-count">0</span></p>
        <p><strong>Ãšltima sincronizaciÃ³n Trello:</strong> <span id="last-sync">Nunca</span></p>
        
        <button id="clear-data-btn" style="background: #ef4444;">ğŸ—‘ï¸ Limpiar Todos los Datos</button>
      </div>
    </section>
  </div>

  <div id="temp-message-container"></div>
  <audio id="sound-complete" src="sounds/complete.mp3" preload="auto"></audio>
  <audio id="sound-break" src="sounds/break.mpod3" preload="auto"></audio>
  <audio id="sound-task-done" src="sounds/task-done.mp3" preload="auto"></audio>

  <!-- Tour de Bienvenida -->
  <div id="welcome-tour-overlay" class="welcome-tour-overlay">
    <div class="welcome-tour-modal">
      <div class="welcome-tour-content">
        <h3 id="tour-title"></h3>
        <p id="tour-description"></p>
        <div class="tour-highlight-image-container">
            <img id="tour-highlight-image" src="" alt="Resaltado de la funciÃ³n" class="tour-highlight-image" style="display: none;">
        </div>
      </div>
      <div class="welcome-tour-navigation">
        <button id="tour-back-btn" class="tour-nav-btn" style="display: none;">â¬…ï¸ Anterior</button>
        <div id="tour-dots" class="tour-dots"></div>
        <button id="tour-next-btn" class="tour-nav-btn">Siguiente â¡ï¸</button>
        <button id="tour-skip-btn" class="tour-nav-btn button-danger">Omitir Tour</button>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script> <!-- main.js ahora es un script tradicional -->
</body>
</html>

