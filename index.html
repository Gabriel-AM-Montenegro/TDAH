<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App TDAH</title>
  <link rel="stylesheet" href="css/styles1.css">

  <!-- Firebase SDKs: Cargados con las versiones de compatibilidad para exponer el objeto global 'firebase' -->
  <!-- Esto evita los problemas de 'import'/'export' cuando no se cargan como m√≥dulos ES -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- Si usas Analytics, descomenta la l√≠nea de abajo -->
  <!-- <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script> -->

</head>
<body>
  <div class="container">

    <header>
      <h1>üß† TDAH Helper App</h1>
      <p>Tu asistente personal para organizaci√≥n y productividad</p>
      <!-- user-info-area: Se ajustar√° din√°micamente para centrar los botones cuando no hay sesi√≥n -->
      <div id="user-info-area" style="font-size: 0.8em; color: var(--text-light); margin-top: 10px; display: flex; align-items: center; flex-wrap: wrap;">
        <span id="user-display-name">Cargando usuario...</span>
        <div class="auth-buttons-wrapper"> <!-- Nuevo wrapper para los botones -->
            <button id="google-signin-btn" class="button-primary auth-btn" style="display: none;">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
              Iniciar con Google
            </button>
            <button id="email-signin-toggle-btn" class="button-secondary auth-btn" style="display: none;">
              Iniciar con Email
            </button>
            <button id="anonymous-signin-btn" class="button-secondary auth-btn" style="display: none;">
              Continuar como An√≥nimo
            </button>
        </div>
        <button id="logout-btn" class="button-secondary" style="display: none;">Cerrar Sesi√≥n</button>
      </div>
    </header>

    <!-- Formulario de inicio de sesi√≥n/registro con Email -->
    <div id="email-auth-form" class="auth-form-card" style="display: none; margin-top: 20px; padding: 20px; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3>Iniciar Sesi√≥n / Registrarse con Email</h3>
      <input type="email" id="email-input" placeholder="Correo electr√≥nico" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
      <input type="password" id="password-input" placeholder="Contrase√±a" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      <button id="email-signup-btn" class="button-primary" style="margin-right: 10px;">Registrarse</button>
      <button id="email-login-btn" class="button-secondary">Iniciar Sesi√≥n</button>
      <button id="email-form-close-btn" class="button-danger" style="float: right;">X</button>
    </div>

    <div class="nav-tabs">
      <button id="btn-pomodoro" class="active">‚è±Ô∏è Pomodoro</button>
      <button id="btn-tareas">üìã Tareas Importantes</button>
      <button id="btn-checklist">‚úÖ Checklist R√°pido</button>
      <button id="btn-journal">üìù Journal</button>
      <button id="btn-notas">üìù Notas Blog</button>
      <button id="btn-config">‚öôÔ∏è Configuraci√≥n</button>
    </div>

    <section id="pomodoro" class="seccion active">
      <h2>‚è±Ô∏è Temporizador Pomodoro</h2>
      <div id="timer">25:00</div>
      <div class="pomodoro-buttons">
        <button id="start-timer-btn">‚ñ∂Ô∏è Iniciar</button>
        <button id="pause-pomodoro-btn">‚è∏Ô∏è Pausar</button>
        <button id="reset-timer-btn">üîÑ Resetear</button>
      </div>
      <div class="help-text">
        üí° 25 min de trabajo concentrado + 5 min de descanso. ¬°Perfecto para TDAH!
      </div>
    </section>

    <section id="tareas" class="seccion">
      <h2>üìã Tareas Importantes (Trello)</h2>
      <div id="trello-status" class="status-indicator status-disconnected">
        ‚ùå Trello no conectado
      </div>
      <div id="tareas-content">
        <p>Configura tu conexi√≥n a Trello para ver las tareas que vencen hoy.</p>
        <button id="config-trello-btn">‚öôÔ∏è Configurar Trello</button>
      </div>
      <ul id="listaTareas"></ul>
    </section>

    <section id="checklist" class="seccion">
      <h2>‚úÖ Checklist R√°pido</h2>
      <div class="mit-explanation">
        <p>La clave es no abrumarse. Al inicio de cada d√≠a, identifica las <strong>3 tareas m√°s importantes (MITs - Most Important Tasks)</strong>. Si terminas esas, puedes pasar a otras, pero el objetivo es asegurar lo crucial.</p>
        <p>Marca hasta 3 tareas como MITs usando la casilla "MIT". Estas se destacar√°n con un color especial. ¬°Puedes a√±adir m√°s tareas en cualquier momento!</p>
      </div>
      <div class="input-group">
        <input type="text" id="checkItem" placeholder="Nuevo √≠tem del checklist..." />
        <button id="add-check-item-btn">‚ûï Agregar</button>
      </div>
      <ul id="checkList"></ul>
      <div class="help-text">
        üí° Para tareas peque√±as y recordatorios r√°pidos del d√≠a
      </div>
    </section>

    <section id="journal" class="seccion">
        <h2>üìù Journal</h2>
        <p class="subtitle">Un espacio reflexivo para documentar emociones, actividades y situaciones significativas de tu jornada, fomentando el autoconocimiento y el bienestar.</p>
        <textarea id="journalEntry" rows="10" placeholder="Escribe aqu√≠ tu entrada del diario..."></textarea>
        <button id="save-journal-entry-btn">Guardar Entrada</button>

        <h3>Entradas Anteriores:</h3>
        <ul id="journalEntriesList">
            <!-- Las entradas del diario se cargar√°n aqu√≠ din√°micamente -->
        </ul>
    </section>

    <section id="notas" class="seccion">
      <h2>üìù Notas de Blog TDAH</h2>
      <div id="blog-content">
        <p>Cargando art√≠culos sobre TDAH...</p>
        </div>
      <button id="refresh-blog-btn">üîÑ Actualizar Art√≠culos</button>
    </section>

    <section id="nutricion" class="seccion">
        <h2>üçé Nutrici√≥n y Recetas</h2>
        <div id="nutricion-content">
            <p>Cargando recomendaciones nutricionales y recetas...</p>
            </div>
        <button id="refresh-nutricion-btn">üîÑ Actualizar Contenido</button>
    </section>

    <section id="config" class="seccion">
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      
      <div class="config-card" id="config-card">
        <h3>üîó Conectar con Trello</h3>
        
        <div class="config-step">
          <label for="api-key">API Key de Trello:</label>
          <input type="text" id="api-key" placeholder="Pega aqu√≠ tu API Key...">
          <div class="help-text">
            üìù Obt√©n tu API Key en: <a href="https://trello.com/app-key" target="_blank">https://trello.com/app-key</a>
          </div>
        </div>

        <div class="config-step">
          <label for="token">Token de Trello:</label>
          <input type="text" id="token" placeholder="Pega aqu√≠ tu Token...">
          <div class="help-text">
            üìù Genera tu Token clickeando en el link que aparece junto a tu API Key
          </div>
        </div>

        <div class="config-step">
          <label for="board-id">ID del Board:</label>
          <input type="text" id="board-id" placeholder="ID de tu board de Trello...">
          <div class="help-text">
            üìù Encuentra el ID en la URL de tu board: trello.com/b/<strong>ID_AQUI</strong>/nombre-board
          </div>
        </div>

        <button id="test-trello-btn">üîç Probar Conexi√≥n</button>
        <button id="save-trello-config-btn">üíæ Guardar Configuraci√≥n</button>
        
        <div class="success-message" id="trello-success-message">
          ‚úÖ ¬°Conexi√≥n exitosa! Ya puedes ver tus tareas de Trello.
        </div>
      </div>

      <div class="config-card">
        <h3>üìä Estado de la App</h3>
        <p><strong>Tareas guardadas:</strong> <span id="tasks-count">0</span></p>
        <p><strong>Checklist items:</strong> <span id="checklist-count">0</span></p>
        <p><strong>√öltima sincronizaci√≥n Trello:</strong> <span id="last-sync">Nunca</span></p>
        
        <button id="clear-data-btn" style="background: #ef4444;">üóëÔ∏è Limpiar Todos los Datos</button>
      </div>
    </section>
  </div>

  <div id="temp-message-container"></div>
  <audio id="sound-complete" src="sounds/complete.mp3" preload="auto"></audio>
  <audio id="sound-break" src="sounds/break.mp3" preload="auto"></audio>
  <audio id="sound-task-done" src="sounds/task-done.mp3" preload="auto"></audio>

  <!-- Script de inicializaci√≥n de Firebase y autenticaci√≥n -->
  <!-- Este script se ejecuta despu√©s de que los SDK de Firebase se han cargado (en el head) -->
  <!-- y antes de main.js, asegurando que 'firebase' est√© definido. -->
  <script>
    console.log("Script inline en body: Iniciando configuraci√≥n de Firebase.");
    // Configuraci√≥n de Firebase proporcionada por el usuario
    // ¬°IMPORTANTE! Reemplaza estos valores con los de TU proyecto de Firebase
    // Encu√©ntralos en la Consola de Firebase > Configuraci√≥n del proyecto > Tus apps (aplicaci√≥n web)
    const firebaseConfig = {
        apiKey: "AIzaSyAaC7FvY_9bDHBvl36YWAIIO9qXyvqZrUw", // <--- VERIFICA ESTE VALOR
        authDomain: "tdah-app-efca9.firebaseapp.com",    // <--- VERIFICA ESTE VALOR
        projectId: "tdah-app-efca9",                     // <--- VERIFICA ESTE VALOR
        storageBucket: "tdah-app-efca9.firebasestorage.app",
        messagingSenderId: "765424031369",
        appId: "1:765424031369:web:838eca686f68f21daa5858",
        measurementId: "G-QY7X98XZZV"
    };

    // Inicializar Firebase y exponer a window para main.js
    // Usamos las funciones de la API global de Firebase (v8 compat)
    window.firebaseApp = firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore(); // Acceder a Firestore
    window.auth = firebase.auth();   // Acceder a Auth

    // Asegurarse de usar el appId de la configuraci√≥n de Firebase
    window.appId = firebaseConfig.appId;
    // __initial_auth_token es una variable global proporcionada por el entorno Canvas
    window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    console.log("Script inline en body: Firebase inicializado y variables expuestas.");

    // Funciones globales que main.js tambi√©n podr√≠a necesitar o que el HTML llama directamente
    // Definirlas aqu√≠ para asegurar que est√©n disponibles cuando DOMContentLoaded se dispare.
    window.mostrarSeccion = function(idSeccion) {
        console.log(`Intentando mostrar secci√≥n: ${idSeccion}`);
        document.querySelectorAll('.seccion').forEach(seccion => {
            seccion.classList.remove('active');
        });
        document.querySelectorAll('.nav-tabs button').forEach(button => {
            button.classList.remove('active');
        });

        const seccionActiva = document.getElementById(idSeccion);
        if (seccionActiva) {
            seccionActiva.classList.add('active');
            console.log(`Secci√≥n ${idSeccion} activada.`);
        } else {
            console.warn(`Secci√≥n con ID ${idSeccion} no encontrada.`);
        }
        const botonActivo = document.getElementById(`btn-${idSeccion}`);
        if (botonActivo) {
            botonActivo.classList.add('active');
            console.log(`Bot√≥n ${idSeccion} activado.`);
        } else {
            console.warn(`Bot√≥n con ID btn-${idSeccion} no encontrado.`);
        }
    };

    window.showTempMessage = function(message, type = 'info', duration = 3000) {
        console.log(`Mostrar mensaje temporal: [${type}] ${message}`);
        const tempMessageContainer = document.getElementById('temp-message-container');
        if (!tempMessageContainer) {
            console.error("Contenedor de mensajes temporales no encontrado.");
            return;
        }
        const msgElement = document.createElement('div');
        msgElement.className = `temp-message ${type}`;
        msgElement.textContent = message;
        tempMessageContainer.appendChild(msgElement);

        msgElement.offsetHeight;
        msgElement.classList.add('show');

        setTimeout(() => {
            msgElement.classList.remove('show');
            msgElement.classList.add('hide');
            msgElement.addEventListener('transitionend', () => msgElement.remove(), { once: true });
        }, duration);
    };

    // Funci√≥n para disparar el efecto de confeti
    window.triggerConfetti = function() {
        let confettiContainer = document.getElementById('confetti-container');
        if (!confettiContainer) {
            confettiContainer = document.createElement('div');
            confettiContainer.id = 'confetti-container';
            document.body.appendChild(confettiContainer);
        }

        const colors = ['var(--primary-color)', 'var(--secondary-color)', '#FFD700', '#FF69B4', '#00FFFF']; // Colores para el confeti
        const numConfetti = 50; // N√∫mero de piezas de confeti

        for (let i = 0; i < numConfetti; i++) {
            const piece = document.createElement('div');
            piece.className = 'confetti-piece';
            piece.style.left = `${Math.random() * 100}vw`; // Posici√≥n horizontal aleatoria
            piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDuration = `${Math.random() * 2 + 3}s`; // Duraci√≥n aleatoria entre 3-5s
            piece.style.animationDelay = `${Math.random() * 0.5}s`; // Ligero retraso para efecto escalonado
            piece.style.width = `${Math.random() * 8 + 5}px`; // Tama√±o aleatorio
            piece.style.height = piece.style.width;
            confettiContainer.appendChild(piece);
        }

        // Limpiar el confeti despu√©s de la animaci√≥n
        setTimeout(() => {
            confettiContainer.innerHTML = ''; // Eliminar todas las piezas
        }, 5000); // Coincide con la duraci√≥n m√°s larga de la animaci√≥n
    };

    // --- Variables y funciones globales del Pomodoro ---
    let timer;
    let isRunning = false;
    let timeLeft = 25 * 60; // Default: 25 minutos de trabajo
    let isBreakTime = false; // Para saber si estamos en tiempo de descanso
    const timerDisplay = document.getElementById('timer');
    const startTimerBtn = document.getElementById('start-timer-btn');
    const pausePomodoroBtn = document.getElementById('pause-pomodoro-btn');
    const resetTimerBtn = document.getElementById('reset-timer-btn');

    function updateTimerDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function savePomodoroState(newTimeLeft, newIsRunning, newIsBreakTime) {
        if (!window.currentUserId) {
            console.warn("Pomodoro: No hay usuario autenticado para guardar el estado.");
            return;
        }
        try {
            const pomodoroSettingsDocRef = db.collection(`artifacts/${appId}/users/${currentUserId}/pomodoroSettings`).doc('current');
            await pomodoroSettingsDocRef.set({
                timeLeft: newTimeLeft,
                isRunning: newIsRunning,
                isBreakTime: newIsBreakTime,
                lastUpdated: new Date().toISOString()
            });
            console.log("Pomodoro: Estado guardado en Firestore.");
        } catch (error) {
            console.error("Pomodoro: Error al guardar estado:", error);
            window.showTempMessage(`Error al guardar Pomodoro: ${error.message}`, 'error');
        }
    }

    function startTimer() {
        if (!isRunning) {
            isRunning = true;
            savePomodoroState(timeLeft, true, isBreakTime);
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    isRunning = false;
                    savePomodoroState(0, false, isBreakTime);
                    
                    if (!isBreakTime) { // Si termin√≥ el tiempo de trabajo
                        window.triggerConfetti();
                        document.getElementById('sound-complete').play();
                        window.showTempMessage('¬°Tiempo de trabajo completado!', 'success', 4000);

                        setTimeout(() => {
                            // Usar confirm() por ahora, idealmente reemplazar con un modal personalizado
                            const startBreak = confirm('¬°Excelente trabajo! ¬øQuieres comenzar tu descanso de 5 minutos?');
                            if (startBreak) {
                                timeLeft = 5 * 60; // 5 minutos para descanso
                                isBreakTime = true;
                                updateTimerDisplay();
                                savePomodoroState(timeLeft, true, isBreakTime);
                                document.getElementById('sound-break').play();
                                window.showTempMessage('¬°Disfruta tu descanso!', 'info', 4000);
                                startTimer();
                            } else {
                                resetTimer();
                            }
                        }, 1000);
                    } else { // Si termin√≥ el tiempo de descanso
                        window.showTempMessage('¬°Descanso terminado! ¬°Has recargado energ√≠as! Es hora de volver a concentrarte y darlo todo. ¬°A por ello!', 'info', 7000); // Mensaje motivador
                        resetTimer();
                    }
                }
            }, 1000);
            console.log("Pomodoro: Temporizador iniciado.");
        }
    }

    function pausarPomodoro() {
        clearInterval(timer);
        isRunning = false;
        savePomodoroState(timeLeft, false, isBreakTime);
        window.showTempMessage('Temporizador pausado.', 'info');
        console.log("Pomodoro: Temporizador pausado.");
    }

    function resetTimer() {
        clearInterval(timer);
        isRunning = false;
        timeLeft = 25 * 60; // Siempre resetear a 25 min de trabajo
        isBreakTime = false; // Asegurarse de que no estamos en tiempo de descanso
        updateTimerDisplay();
        savePomodoroState(timeLeft, false, isBreakTime);
        window.showTempMessage('Temporizador reiniciado.', 'info');
        console.log("Pomodoro: Temporizador reiniciado.");
    }

    // --- Funci√≥n para cargar todos los datos del usuario y configurar listeners ---
    window.loadAllUserData = function() {
        console.log("loadAllUserData: Cargando datos y configurando listeners para el usuario:", window.currentUserId);

        // --- L√≥gica del Temporizador Pomodoro ---
        if (timerDisplay && startTimerBtn && pausePomodoroBtn && resetTimerBtn) {
            const pomodoroSettingsDocRef = db.collection(`artifacts/${appId}/users/${currentUserId}/pomodoroSettings`).doc('current');
            pomodoroSettingsDocRef.onSnapshot((docSnap) => {
                console.log("Pomodoro: Recibiendo snapshot de settings.");
                if (docSnap.exists) {
                    const settings = docSnap.data();
                    timeLeft = settings.timeLeft;
                    isRunning = settings.isRunning;
                    isBreakTime = settings.isBreakTime || false;
                    updateTimerDisplay();
                    if (isRunning && settings.lastUpdated) {
                        const elapsedSinceLastUpdate = (Date.now() - new Date(settings.lastUpdated).getTime()) / 1000;
                        timeLeft = Math.max(0, timeLeft - Math.floor(elapsedSinceLastUpdate));
                        if (timeLeft > 0 && !timer) {
                            startTimer();
                        } else if (timeLeft <= 0) {
                            clearInterval(timer);
                            isRunning = false;
                            savePomodoroState(0, false, isBreakTime);
                            if (!isBreakTime) {
                                window.triggerConfetti();
                                document.getElementById('sound-complete').play();
                                window.showTempMessage('¬°Tiempo de trabajo completado!', 'success', 4000);
                                setTimeout(() => {
                                    const startBreak = confirm('¬°Excelente trabajo! ¬øQuieres comenzar tu descanso de 5 minutos?');
                                    if (startBreak) {
                                        timeLeft = 5 * 60;
                                        isBreakTime = true;
                                        updateTimerDisplay();
                                        savePomodoroState(timeLeft, true, isBreakTime);
                                        document.getElementById('sound-break').play();
                                        window.showTempMessage('¬°Disfruta tu descanso!', 'info', 4000);
                                        startTimer();
                                    } else {
                                        resetTimer();
                                    }
                                }, 1000);
                            } else {
                                window.showTempMessage('¬°Descanso terminado! ¬°Has recargado energ√≠as! Es hora de volver a concentrarte y darlo todo. ¬°A por ello!', 'info', 7000); // Mensaje motivador
                                resetTimer();
                            }
                        }
                    }
                } else {
                    console.log("Pomodoro: No hay settings, creando por defecto.");
                    pomodoroSettingsDocRef.set({ timeLeft: 25 * 60, isRunning: false, isBreakTime: false, lastUpdated: new Date().toISOString() });
                }
            }, (error) => {
                console.error("Pomodoro: Error al cargar settings:", error);
                window.showTempMessage(`Error al cargar Pomodoro: ${error.message}`, 'error');
            });

            // Adjuntar event listeners a los botones de Pomodoro
            startTimerBtn.addEventListener('click', startTimer);
            pausePomodoroBtn.addEventListener('click', pausarPomodoro);
            resetTimerBtn.addEventListener('click', resetTimer);
        } else {
            console.warn("Pomodoro: Elementos HTML del Temporizador no encontrados.");
        }

        // --- L√≥gica del Journal ---
        const journalEntryTextarea = document.getElementById('journalEntry');
        const saveJournalEntryButton = document.getElementById('save-journal-entry-btn');
        const journalEntriesList = document.getElementById('journalEntriesList');
        const journalCollectionRef = db.collection(`artifacts/${appId}/users/${currentUserId}/journalEntries`);

        if (journalEntryTextarea && saveJournalEntryButton && journalEntriesList) {
            journalCollectionRef.orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                console.log("Journal: Recibiendo snapshot de entradas.");
                journalEntriesList.innerHTML = '';
                if (snapshot.empty) {
                    journalEntriesList.innerHTML = '<li>No hay entradas en el diario a√∫n.</li>';
                    return;
                }
                snapshot.forEach(doc => {
                    const entry = doc.data();
                    const listItem = document.createElement('li');
                    const dateSpan = document.createElement('span');
                    dateSpan.className = 'journal-date';
                    dateSpan.textContent = new Date(entry.timestamp).toLocaleString('es-ES', {
                        year: 'numeric', month: 'long', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    const contentDiv = document.createElement('div');
                    contentDiv.textContent = entry.text;

                    listItem.appendChild(dateSpan);
                    listItem.appendChild(contentDiv);
                    journalEntriesList.appendChild(listItem);
                });
            }, (error) => {
                console.error("Journal: Error al escuchar entradas del diario:", error);
                window.showTempMessage(`Error al cargar diario: ${error.message}`, 'error');
            });

            saveJournalEntryButton.addEventListener('click', async () => {
                const entryText = journalEntryTextarea.value.trim();
                if (entryText) {
                    try {
                        await journalCollectionRef.add({
                            text: entryText,
                            timestamp: new Date().toISOString()
                        });
                        journalEntryTextarea.value = '';
                        window.showTempMessage('Entrada guardada con √©xito!', 'success');
                    } catch (error) {
                        console.error("Journal: Error al guardar entrada del diario:", error);
                        window.showTempMessage(`Error al guardar: ${error.message}`, 'error');
                    }
                } else {
                    window.showTempMessage('Por favor, escribe algo en tu entrada antes de guardar.', 'warning');
                }
            });
        } else {
            console.warn("Journal: Elementos HTML del Journal no encontrados.");
        }


        // --- L√≥gica del Checklist ---
        const checkItemInput = document.getElementById('checkItem');
        const addCheckItemBtn = document.getElementById('add-check-item-btn');
        const checkListUl = document.getElementById('checkList');
        const checklistCollectionRef = db.collection(`artifacts/${appId}/users/${currentUserId}/checklistItems`);

        if (checkItemInput && addCheckItemBtn && checkListUl) {
            checklistCollectionRef.orderBy('timestamp', 'asc').onSnapshot((snapshot) => {
                console.log("Checklist: Recibiendo snapshot de √≠tems.");
                checkListUl.innerHTML = '';
                if (snapshot.empty) {
                    checkListUl.innerHTML = '<li>No hay √≠tems en el checklist a√∫n.</li>';
                    return;
                }
                snapshot.forEach(docSnap => {
                    const item = docSnap.data();
                    const itemId = docSnap.id;
                    const listItem = document.createElement('li');
                    // A√±adir checkbox para MIT
                    listItem.innerHTML = `
                        <input type="checkbox" class="completion-checkbox" id="check-${itemId}" ${item.completed ? 'checked' : ''}>
                        <label for="check-${itemId}"><span>${item.text}</span></label>
                        <div class="mit-controls">
                            <input type="checkbox" class="mit-checkbox" id="mit-${itemId}" ${item.isMIT ? 'checked' : ''}>
                            <label for="mit-${itemId}">MIT</label>
                        </div>
                        <button class="button-danger" data-id="${itemId}">‚ùå</button>
                    `;
                    checkListUl.appendChild(listItem);

                    // Aplicar clase MIT si es necesario
                    if (item.isMIT) {
                        listItem.classList.add('mit-task');
                    }
                    if (item.completed) {
                        listItem.querySelector('span').classList.add('task-completed');
                    }


                    // Event listener para el checkbox de completado
                    listItem.querySelector('.completion-checkbox').addEventListener('change', async (e) => {
                        try {
                            await checklistCollectionRef.doc(itemId).update({
                                completed: e.target.checked
                            });
                            if (e.target.checked) {
                                listItem.querySelector('span').classList.add('task-completed');
                                document.getElementById('sound-task-done').play();
                                window.showTempMessage('¬°Tarea completada!', 'success');
                            } else {
                                listItem.querySelector('span').classList.remove('task-completed');
                            }
                            console.log(`Checklist: √çtem ${itemId} actualizado.`);
                        } catch (error) {
                            console.error("Checklist: Error al actualizar √≠tem:", error);
                            window.showTempMessage(`Error al actualizar tarea: ${error.message}`, 'error');
                        }
                    });

                    // Event listener para el checkbox de MIT
                    listItem.querySelector('.mit-checkbox').addEventListener('change', async (e) => {
                        const mitCheckboxes = document.querySelectorAll('.mit-checkbox:checked');
                        if (e.target.checked && mitCheckboxes.length > 3) {
                            e.target.checked = false; // Desmarcar si excede el l√≠mite
                            window.showTempMessage('Solo puedes seleccionar hasta 3 MITs a la vez.', 'warning');
                            return;
                        }
                        try {
                            await checklistCollectionRef.doc(itemId).update({
                                isMIT: e.target.checked
                            });
                            if (e.target.checked) {
                                listItem.classList.add('mit-task');
                            } else {
                                listItem.classList.remove('mit-task');
                            }
                            console.log(`Checklist: √çtem ${itemId} MIT actualizado.`);
                        } catch (error) {
                            console.error("Checklist: Error al actualizar MIT:", error);
                            window.showTempMessage(`Error al actualizar MIT: ${error.message}`, 'error');
                        }
                    });


                    // Event listener para el bot√≥n de eliminar
                    listItem.querySelector('.button-danger').addEventListener('click', async (e) => {
                        const itemToDeleteId = e.target.dataset.id;
                        try {
                            await checklistCollectionRef.doc(itemToDeleteId).delete();
                            window.showTempMessage('Elemento eliminado del checklist.', 'info');
                            console.log(`Checklist: √çtem ${itemToDeleteId} eliminado.`);
                        } catch (error) {
                            console.error("Checklist: Error al eliminar √≠tem:", error);
                            window.showTempMessage(`Error al eliminar: ${error.message}`, 'error');
                        }
                    });
                });
            }, (error) => {
                console.error("Checklist: Error al escuchar √≠tems:", error);
                window.showTempMessage(`Error al cargar checklist: ${error.message}`, 'error');
            });

            async function addCheckItem() {
                const itemText = checkItemInput.value.trim();
                if (itemText) {
                    try {
                        await checklistCollectionRef.add({
                            text: itemText,
                            completed: false,
                            isMIT: false, // Nuevo campo para MIT
                            timestamp: new Date().toISOString()
                        });
                        checkItemInput.value = '';
                        window.showTempMessage('Elemento a√±adido al checklist.', 'success');
                        console.log("Checklist: Nuevo √≠tem a√±adido.");
                    } catch (error) {
                        console.error("Checklist: Error al a√±adir √≠tem:", error);
                        window.showTempMessage(`Error al a√±adir: ${error.message}`, 'error');
                    }
                } else {
                    window.showTempMessage('Por favor, escribe un √≠tem para el checklist.', 'warning');
                }
            }
            addCheckItemBtn.addEventListener('click', addCheckItem);
        } else {
            console.warn("Checklist: Elementos HTML del Checklist no encontrados.");
        }


        // --- L√≥gica de Trello ---
        const trelloApiKeyInput = document.getElementById('api-key');
        const trelloTokenInput = document.getElementById('token');
        const trelloBoardIdInput = document.getElementById('board-id');
        const trelloStatusDiv = document.getElementById('trello-status');
        const trelloSuccessMessage = document.getElementById('trello-success-message');
        const trelloConfigDocRef = db.collection(`artifacts/${appId}/users/${currentUserId}/trelloConfig`).doc('settings');

        const configTrelloBtn = document.getElementById('config-trello-btn');
        const testTrelloBtn = document.getElementById('test-trello-btn');
        const saveTrelloConfigBtn = document.getElementById('save-trello-config-btn');

        if (trelloApiKeyInput && trelloTokenInput && trelloBoardIdInput && trelloStatusDiv && trelloSuccessMessage && configTrelloBtn && testTrelloBtn && saveTrelloConfigBtn) {
            trelloConfigDocRef.onSnapshot((docSnap) => {
                console.log("Trello: Recibiendo snapshot de configuraci√≥n.");
                if (docSnap.exists) {
                    const config = docSnap.data();
                    trelloApiKeyInput.value = config.apiKey || '';
                    trelloTokenInput.value = config.token || '';
                    trelloBoardIdInput.value = config.boardId || '';
                    probarConexionTrello();
                } else {
                    console.log("Trello: No hay configuraci√≥n, inicializando campos vac√≠os.");
                    trelloApiKeyInput.value = '';
                    trelloTokenInput.value = '';
                    trelloBoardIdInput.value = '';
                    trelloStatusDiv.textContent = '‚ùå Trello no conectado';
                    trelloStatusDiv.className = 'status-indicator status-disconnected';
                    trelloSuccessMessage.style.display = 'none';
                }
            }, (error) => {
                console.error("Trello: Error al cargar configuraci√≥n:", error);
                window.showTempMessage(`Error al cargar config Trello: ${error.message}`, 'error');
            });

            async function guardarConfigTrello() {
                const apiKey = trelloApiKeyInput.value.trim();
                const token = trelloTokenInput.value.trim();
                const boardId = trelloBoardIdInput.value.trim();

                if (apiKey && token && boardId) {
                    try {
                        await trelloConfigDocRef.set({ apiKey, token, boardId });
                        window.showTempMessage('Configuraci√≥n de Trello guardada.', 'success');
                        probarConexionTrello();
                        console.log("Trello: Configuraci√≥n guardada.");
                    } catch (error) {
                        console.error("Trello: Error al guardar configuraci√≥n:", error);
                        window.showTempMessage(`Error al guardar config Trello: ${error.message}`, 'error');
                    }
                } else {
                    window.showTempMessage('Por favor, completa todos los campos de configuraci√≥n de Trello.', 'warning');
                }
            }

            async function probarConexionTrello() {
                console.log("Trello: Probando conexi√≥n...");
                const configSnap = await trelloConfigDocRef.get();
                if (!configSnap.exists) {
                    trelloStatusDiv.textContent = '‚ùå Trello no conectado';
                    trelloStatusDiv.className = 'status-indicator status-disconnected';
                    trelloSuccessMessage.style.display = 'none';
                    console.log("Trello: No hay configuraci√≥n para probar.");
                    return;
                }
                const { apiKey, token, boardId } = configSnap.data();

                if (!apiKey || !token || !boardId) {
                    trelloStatusDiv.textContent = '‚ùå Trello no conectado';
                    trelloStatusDiv.className = 'status-indicator status-disconnected';
                    trelloSuccessMessage.style.display = 'none';
                    console.log("Trello: Configuraci√≥n incompleta para probar.");
                    return;
                }

                try {
                    const response = await fetch(`https://api.trello.com/1/boards/${boardId}/lists?key=${apiKey}&token=${token}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.length > 0) {
                            trelloStatusDiv.textContent = '‚úÖ Trello conectado';
                            trelloStatusDiv.className = 'status-indicator status-connected';
                            trelloSuccessMessage.style.display = 'block';
                            window.showTempMessage('Conexi√≥n con Trello exitosa!', 'success');
                            cargarTareasTrello();
                            console.log("Trello: Conexi√≥n exitosa.");
                        } else {
                            trelloStatusDiv.textContent = '‚ö†Ô∏è Board ID inv√°lido o sin listas';
                            trelloStatusDiv.className = 'status-indicator status-warning';
                            trelloSuccessMessage.style.display = 'none';
                            console.warn("Trello: Board ID inv√°lido o sin listas.");
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Error al conectar con Trello');
                    }
                }
                catch (error) {
                    console.error('Trello: Error de conexi√≥n:', error);
                    trelloStatusDiv.textContent = `‚ùå Error: ${error.message}`;
                    trelloStatusDiv.className = 'status-indicator status-disconnected';
                    trelloSuccessMessage.style.display = 'none';
                    window.showTempMessage(`Error de Trello: ${error.message}`, 'error');
                }
            }

            async function cargarTareasTrello() {
                console.log("Trello: Cargando tareas...");
                const configSnap = await trelloConfigDocRef.get();
                if (!configSnap.exists) {
                    console.log("Trello: No hay configuraci√≥n de Trello para cargar tareas.");
                    return;
                }
                const { apiKey, token, boardId } = configSnap.data();

                const listaTareasUl = document.getElementById('listaTareas');
                listaTareasUl.innerHTML = '';

                if (!apiKey || !token || !boardId) {
                    listaTareasUl.innerHTML = '<p>Configura Trello para ver tus tareas.</p>';
                    return;
                }

                try {
                    const listsResponse = await fetch(`https://api.trello.com/1/boards/${boardId}/lists?key=${apiKey}&token=${token}`);
                    const lists = await listsResponse.json();

                    if (!listsResponse.ok) throw new Error(lists.message || 'Error al obtener listas de Trello.');

                    let allCards = [];
                    for (const list of lists) {
                        const cardsResponse = await fetch(`https://api.trello.com/1/lists/${list.id}/cards?key=${apiKey}&token=${token}`);
                        const cards = await cardsResponse.json();
                        if (!cardsResponse.ok) throw new Error(cards.message || `Error al obtener tarjetas de la lista ${list.name}.`);
                        allCards = allCards.concat(cards);
                    }

                    if (allCards.length > 0) {
                        allCards.forEach(card => {
                            const listItem = document.createElement('li');
                            listItem.textContent = card.name;
                            // Puedes a√±adir m√°s detalles como fecha de vencimiento, etiquetas, etc.
                            listaTareasUl.appendChild(listItem);
                        });
                        console.log(`Trello: ${allCards.length} tareas cargadas.`);
                    } else {
                        listaTareasUl.innerHTML = '<li>No hay tareas en tu board de Trello.</li>';
                        console.log("Trello: No hay tareas en el board.");
                    }
                } catch (error) {
                    console.error('Trello: Error al cargar tareas:', error);
                    listaTareasUl.innerHTML = `<li>Error al cargar tareas: ${error.message}</li>`;
                    window.showTempMessage(`Error al cargar tareas de Trello: ${error.message}`, 'error');
                }
            }
            configTrelloBtn.addEventListener('click', () => window.mostrarSeccion('config'));
            testTrelloBtn.addEventListener('click', probarConexionTrello);
            saveTrelloConfigBtn.addEventListener('click', guardarConfigTrello);
        } else {
            console.warn("Trello: Elementos HTML de Trello no encontrados.");
        }


        // --- L√≥gica de Limpiar Datos ---
        const clearDataBtn = document.getElementById('clear-data-btn');
        if (clearDataBtn) {
            async function limpiarDatos() {
                if (confirm('¬øEst√°s seguro de que quieres limpiar TODOS los datos guardados (Pomodoro, Checklist, Trello Config, Journal)? Esta acci√≥n es irreversible.')) {
                    try {
                        console.log("Limpiar Datos: Iniciando limpieza...");
                        const journalCollectionRef = db.collection(`artifacts/${appId}/users/${currentUserId}/journalEntries`);
                        const checklistCollectionRef = db.collection(`artifacts/${appId}/users/${currentUserId}/checklistItems`);
                        const pomodoroSettingsDocRef = db.collection(`artifacts/${appId}/users/${currentUserId}/pomodoroSettings`).doc('current');
                        const trelloConfigDocRef = db.collection(`artifacts/${appId}/users/${currentUserId}/trelloConfig`).doc('settings');

                        const journalDocs = await journalCollectionRef.get();
                        journalDocs.forEach(async (d) => await d.ref.delete());

                        const checklistDocs = await checklistCollectionRef.get();
                        checklistDocs.forEach(async (d) => await d.ref.delete());

                        const pomodoroDocSnap = await pomodoroSettingsDocRef.get();
                        if (pomodoroDocSnap.exists) {
                            await pomodoroSettingsDocRef.delete();
                            console.log("Limpiar Datos: Configuraci√≥n de Pomodoro eliminada.");
                        }

                        const trelloDocSnap = await trelloConfigDocRef.get();
                        if (trelloDocSnap.exists) {
                            await trelloConfigDocRef.delete();
                            console.log("Limpiar Datos: Configuraci√≥n de Trello eliminada.");
                        }

                        window.showTempMessage('Todos los datos han sido limpiados.', 'info');
                        location.reload();
                    } catch (error) {
                        console.error("Limpiar Datos: Error al limpiar datos:", error);
                        window.showTempMessage(`Error al limpiar datos: ${error.message}`, 'error');
                    }
                }
            }
            clearDataBtn.addEventListener('click', limpiarDatos);
        } else {
            console.warn("Limpiar Datos: Bot√≥n 'clear-data-btn' no encontrado.");
        }


        // --- L√≥gica de Notas de Blog y Nutrici√≥n (no usan DB) ---
        const blogContentDiv = document.getElementById('blog-content');
        const refreshBlogBtn = document.getElementById('refresh-blog-btn');
        if (blogContentDiv && refreshBlogBtn) {
            async function cargarNotasBlog() {
                blogContentDiv.innerHTML = '<p>Cargando art√≠culos...</p>';
                try {
                    const response = await fetch('https://jsonplaceholder.typicode.com/posts?_limit=5');
                    const articles = await response.json();
                    blogContentDiv.innerHTML = '';
                    articles.forEach(article => {
                        const articleCard = document.createElement('div');
                        articleCard.className = 'blog-article-card';
                        articleCard.innerHTML = `
                            <h4>${article.title}</h4>
                            <p>${article.body.substring(0, 100)}...</p>
                            <small>Fuente: Blog de Neurodiversidad</small>
                            <a href="#" class="article-link">Leer M√°s ‚Üó</a>
                        `;
                        blogContentDiv.appendChild(articleCard);
                    });
                    window.showTempMessage('Art√≠culos del blog actualizados.', 'success');
                    console.log("Blog: Art√≠culos cargados.");
                } catch (error) {
                    blogContentDiv.innerHTML = '<p>Error al cargar art√≠culos del blog.</p>';
                    console.error('Blog: Error al cargar notas de blog:', error);
                    window.showTempMessage('Error al cargar art√≠culos del blog.', 'error');
                }
            }
            refreshBlogBtn.addEventListener('click', cargarNotasBlog);
            cargarNotasBlog();
        } else {
            console.warn("Blog: Elementos HTML del Blog no encontrados.");
        }


        const nutricionContentDiv = document.getElementById('nutricion-content');
        const refreshNutricionBtn = document.getElementById('refresh-nutricion-btn');
        if (nutricionContentDiv && refreshNutricionBtn) {
            async function cargarNutricion() {
                nutricionContentDiv.innerHTML = '<p>Cargando recomendaciones...</p>';
                try {
                    const data = [
                        { title: "Hidrataci√≥n Esencial", content: "Beber suficiente agua es crucial para la funci√≥n cerebral y la energ√≠a. Intenta beber 8 vasos al d√≠a.", source: "OMS" },
                        { title: "Omega-3 y Cerebro", content: "Los √°cidos grasos Omega-3, encontrados en pescados grasos y nueces, son vitales para la salud cerebral y la concentraci√≥n.", source: "Harvard Health" },
                        { title: "Alimentos Integrales", content: "Opta por granos enteros, frutas y verduras para un suministro constante de energ√≠a y nutrientes.", source: "Nutrici√≥n al D√≠a" }
                    ];
                    nutricionContentDiv.innerHTML = '';
                    data.forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'nutricion-card';
                        card.innerHTML = `
                            <h4>${item.title}</h4>
                            <p>${item.content}</p>
                            <small>Fuente: ${item.source}</small>
                        `;
                        nutricionContentDiv.appendChild(card);
                    });
                    window.showTempMessage('Contenido de nutrici√≥n actualizado.', 'success');
                    console.log("Nutrici√≥n: Contenido cargado.");
                } catch (error) {
                    nutricionContentDiv.innerHTML = '<p>Error al cargar contenido de nutrici√≥n.</p>';
                    console.error('Nutrici√≥n: Error al cargar nutrici√≥n:', error);
                    window.showTempMessage('Error al cargar contenido de nutrici√≥n.', 'error');
                }
            }
            refreshNutricionBtn.addEventListener('click', cargarNutricion);
            cargarNutricion();
        } else {
            console.warn("Nutrici√≥n: Elementos HTML de Nutrici√≥n no encontrados.");
        }


        // Actualizar contadores de estado
        function updateAppStatus() {
            if (window.currentUserId && window.db) {
                const checklistCollectionRef = window.db.collection(`artifacts/${window.appId}/users/${window.currentUserId}/checklistItems`);
                checklistCollectionRef.get().then(snapshot => {
                    const checklistItemsCount = snapshot.size;
                    const tasksCountElement = document.getElementById('tasks-count');
                    const checklistCountElement = document.getElementById('checklist-count');

                    if (tasksCountElement) tasksCountElement.textContent = checklistItemsCount;
                    if (checklistCountElement) checklistCountElement.textContent = checklistItemsCount;
                }).catch(error => {
                    console.error("Error al obtener el conteo del checklist:", error);
                });
            } else {
                const tasksCountElement = document.getElementById('tasks-count');
                const checklistCountElement = document.getElementById('checklist-count');
                if (tasksCountElement) tasksCountElement.textContent = '0';
                if (checklistCountElement) checklistCountElement.textContent = '0';
            }
        }
        setInterval(updateAppStatus, 5000);
        updateAppStatus();
    }; // Fin de loadAllUserData

    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded: DOM completamente cargado. Iniciando autenticaci√≥n Firebase...");

        // Referencias a elementos de la UI de autenticaci√≥n
        const userDisplayName = document.getElementById('user-display-name');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const emailSigninToggleBtn = document.getElementById('email-signin-toggle-btn');
        const anonymousSigninBtn = document.getElementById('anonymous-signin-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const emailAuthForm = document.getElementById('email-auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailSignupBtn = document.getElementById('email-signup-btn');
        const emailLoginBtn = document.getElementById('email-login-btn');
        const emailFormCloseBtn = document.getElementById('email-form-close-btn');

        // Referencia al √°rea de informaci√≥n del usuario para control de estilo
        const userInfoArea = document.getElementById('user-info-area');
        const authButtonsWrapper = document.querySelector('.auth-buttons-wrapper');


        // Adjuntar event listeners a los botones de navegaci√≥n
        document.getElementById('btn-pomodoro').addEventListener('click', () => window.mostrarSeccion('pomodoro'));
        document.getElementById('btn-tareas').addEventListener('click', () => window.mostrarSeccion('tareas'));
        document.getElementById('btn-checklist').addEventListener('click', () => window.mostrarSeccion('checklist'));
        document.getElementById('btn-journal').addEventListener('click', () => window.mostrarSeccion('journal'));
        document.getElementById('btn-notas').addEventListener('click', () => window.mostrarSeccion('notas'));
        document.getElementById('btn-config').addEventListener('click', () => window.mostrarSeccion('config'));
        console.log("DOMContentLoaded: Event listeners de navegaci√≥n adjuntados.");

        // Manejar la autenticaci√≥n
        window.auth.onAuthStateChanged(async (user) => {
            console.log("onAuthStateChanged: Estado de autenticaci√≥n cambiado.");
            if (user) {
                window.currentUserId = user.uid;
                console.log("onAuthStateChanged: Usuario autenticado. UID:", window.currentUserId);

                // Mostrar informaci√≥n del usuario y bot√≥n de cerrar sesi√≥n
                userDisplayName.textContent = `Bienvenido, ${user.displayName || user.email || user.uid.substring(0, 8)}!`;
                googleSigninBtn.style.display = 'none';
                emailSigninToggleBtn.style.display = 'none';
                anonymousSigninBtn.style.display = 'none';
                authButtonsWrapper.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                emailAuthForm.style.display = 'none';

                userInfoArea.classList.remove('auth-options-visible');
                userDisplayName.style.textAlign = 'right';

                // Cargar todos los datos del usuario y configurar listeners
                window.loadAllUserData();

            } else {
                console.log("onAuthStateChanged: Usuario no autenticado. Mostrando opciones de inicio de sesi√≥n.");
                userDisplayName.textContent = 'Por favor, inicia sesi√≥n:';
                googleSigninBtn.style.display = 'inline-block';
                emailSigninToggleBtn.style.display = 'inline-block';
                anonymousSigninBtn.style.display = 'inline-block';
                authButtonsWrapper.style.display = 'flex';
                logoutBtn.style.display = 'none';
                emailAuthForm.style.display = 'none';

                userInfoArea.classList.add('auth-options-visible');
                userDisplayName.style.textAlign = 'center';
            }
        });

        // Adjuntar event listeners para Google Sign-In y Sign-Out
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await window.auth.signInWithPopup(provider);
                window.showTempMessage('Inicio de sesi√≥n con Google exitoso!', 'success');
            } catch (error) {
                console.error("Error al iniciar sesi√≥n con Google:", error);
                window.showTempMessage(`Error al iniciar sesi√≥n con Google: ${error.message}`, 'error');
            }
        });

        emailSigninToggleBtn.addEventListener('click', () => {
            emailAuthForm.style.display = emailAuthForm.style.display === 'none' ? 'block' : 'none';
        });

        emailFormCloseBtn.addEventListener('click', () => {
            emailAuthForm.style.display = 'none';
            emailInput.value = '';
            passwordInput.value = '';
        });

        emailSignupBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                window.showTempMessage('Por favor, ingresa un correo y una contrase√±a.', 'warning');
                return;
            }
            if (password.length < 6) {
                window.showTempMessage('La contrase√±a debe tener al menos 6 caracteres.', 'warning');
                return;
            }

            try {
                await window.auth.createUserWithEmailAndPassword(email, password);
                window.showTempMessage('Registro exitoso! Has iniciado sesi√≥n.', 'success');
                emailAuthForm.style.display = 'none';
            } catch (error) {
                console.error("Error al registrarse con Email:", error);
                if (error.code === 'auth/email-already-in-use') {
                    window.showTempMessage('Este correo ya est√° registrado. Intenta iniciar sesi√≥n o usa otro correo.', 'error');
                } else {
                    window.showTempMessage(`Error de registro: ${error.message}`, 'error');
                }
            }
        });

        emailLoginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                window.showTempMessage('Por favor, ingresa un correo y una contrase√±a.', 'warning');
                return;
            }

            try {
                await window.auth.signInWithEmailAndPassword(email, password);
                window.showTempMessage('Inicio de sesi√≥n exitoso!', 'success');
                emailAuthForm.style.display = 'none';
            } catch (error) {
                console.error("Error al iniciar sesi√≥n con Email:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    window.showTempMessage('Correo o contrase√±a incorrectos.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    window.showTempMessage('Formato de correo electr√≥nico inv√°lido.', 'error');
                } else {
                    window.showTempMessage(`Error de inicio de sesi√≥n: ${error.message}`, 'error');
                }
            }
        });

        anonymousSigninBtn.addEventListener('click', async () => {
            try {
                if (window.initialAuthToken) {
                    console.log("anonymousSigninBtn: Usando initialAuthToken.");
                    await window.auth.signInWithCustomToken(window.initialAuthToken);
                } else {
                    console.log("anonymousSigninBtn: Usando signInAnonymously.");
                    await window.auth.signInAnonymously();
                }
                window.showTempMessage('Has iniciado sesi√≥n como usuario an√≥nimo.', 'info');
            } catch (error) {
                console.error("Error al iniciar sesi√≥n como an√≥nimo:", error);
                window.showTempMessage(`Error al iniciar sesi√≥n an√≥nima: ${error.message}`, 'error');
            }
        });


        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await window.auth.signOut();
                window.showTempMessage('Sesi√≥n cerrada.', 'info');
                location.reload(); 
            } catch (error) {
                console.error("Error al cerrar sesi√≥n:", error);
                window.showTempMessage(`Error al cerrar sesi√≥n: ${error.message}`, 'error');
            }
        });


        window.mostrarSeccion('pomodoro');
        console.log("DOMContentLoaded: Secci√≥n Pomodoro inicializada como activa.");

    });
  </script>

  <!-- main.js se carga al final del body para asegurar que todos los elementos HTML est√©n disponibles -->
  <script src="js/main.js"></script>
</body>
</html>