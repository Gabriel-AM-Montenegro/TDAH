<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App TDAH</title>
  <link rel="stylesheet" href="css/styles1.css">

  <!-- Firebase SDKs: Cargados con las versiones de compatibilidad para exponer el objeto global 'firebase' -->
  <!-- Esto evita los problemas de 'import'/'export' cuando no se cargan como módulos ES -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- Si usas Analytics, descomenta la línea de abajo -->
  <!-- <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script> -->

</head>
<body>
  <div class="container">

    <header>
      <h1>� TDAH Helper App</h1>
      <p>Tu asistente personal para organización y productividad</p>
      <!-- user-info-area: Se ajustará dinámicamente para centrar los botones cuando no hay sesión -->
      <div id="user-info-area" style="font-size: 0.8em; color: var(--text-light); margin-top: 10px; display: flex; align-items: center; justify-content: flex-end; flex-wrap: wrap;">
        <span id="user-display-name" style="margin-right: 10px;">Cargando usuario...</span>
        <button id="google-signin-btn" class="button-primary" style="display: none; margin-right: 10px; margin-bottom: 5px; min-width: 180px;">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
          Iniciar con Google
        </button>
        <button id="email-signin-toggle-btn" class="button-secondary" style="display: none; margin-right: 10px; margin-bottom: 5px; min-width: 180px;">
          Iniciar con Email
        </button>
        <button id="anonymous-signin-btn" class="button-secondary" style="display: none; margin-bottom: 5px; min-width: 180px;">
          Continuar como Anónimo
        </button>
        <button id="logout-btn" class="button-secondary" style="display: none; margin-left: 10px; margin-bottom: 5px;">Cerrar Sesión</button>
      </div>
    </header>

    <!-- Formulario de inicio de sesión/registro con Email -->
    <div id="email-auth-form" class="auth-form-card" style="display: none; margin-top: 20px; padding: 20px; border-radius: 8px; background-color: #f9f9f9; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <h3>Iniciar Sesión / Registrarse con Email</h3>
      <input type="email" id="email-input" placeholder="Correo electrónico" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
      <input type="password" id="password-input" placeholder="Contraseña" style="width: calc(100% - 20px); padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
      <button id="email-signup-btn" class="button-primary" style="margin-right: 10px;">Registrarse</button>
      <button id="email-login-btn" class="button-secondary">Iniciar Sesión</button>
      <button id="email-form-close-btn" class="button-danger" style="float: right;">X</button>
    </div>

    <div class="nav-tabs">
      <button id="btn-pomodoro" class="active">⏱️ Pomodoro</button>
      <button id="btn-tareas">📋 Tareas Importantes</button>
      <button id="btn-checklist">✅ Checklist Rápido</button>
      <button id="btn-journal">📝 Journal</button>
      <button id="btn-notas">📝 Notas Blog</button>
      <button id="btn-config">⚙️ Configuración</button>
    </div>

    <section id="pomodoro" class="seccion active">
      <h2>⏱️ Temporizador Pomodoro</h2>
      <div id="timer">25:00</div>
      <div class="pomodoro-buttons">
        <button id="start-timer-btn">▶️ Iniciar</button>
        <button id="pause-pomodoro-btn">⏸️ Pausar</button>
        <button id="reset-timer-btn">🔄 Resetear</button>
      </div>
      <div class="help-text">
        💡 25 min de trabajo concentrado + 5 min de descanso. ¡Perfecto para TDAH!
      </div>
    </section>

    <section id="tareas" class="seccion">
      <h2>📋 Tareas Importantes (Trello)</h2>
      <div id="trello-status" class="status-indicator status-disconnected">
        ❌ Trello no conectado
      </div>
      <div id="tareas-content">
        <p>Configura tu conexión a Trello para ver las tareas que vencen hoy.</p>
        <button id="config-trello-btn">⚙️ Configurar Trello</button>
      </div>
      <ul id="listaTareas"></ul>
    </section>

    <section id="checklist" class="seccion">
      <h2>✅ Checklist Rápido</h2>
      <div class="input-group">
        <input type="text" id="checkItem" placeholder="Nuevo ítem del checklist..." />
        <button id="add-check-item-btn">➕ Agregar</button>
      </div>
      <ul id="checkList"></ul>
      <div class="help-text">
        💡 Para tareas pequeñas y recordatorios rápidos del día
      </div>
    </section>

    <section id="journal" class="seccion">
        <h2>📝 Journal</h2>
        <p class="subtitle">Un espacio reflexivo para documentar emociones, actividades y situaciones significativas de tu jornada, fomentando el autoconocimiento y el bienestar.</p>
        <textarea id="journalEntry" rows="10" placeholder="Escribe aquí tu entrada del diario..."></textarea>
        <button id="save-journal-entry-btn">Guardar Entrada</button>

        <h3>Entradas Anteriores:</h3>
        <ul id="journalEntriesList">
            <!-- Las entradas del diario se cargarán aquí dinámicamente -->
        </ul>
    </section>

    <section id="notas" class="seccion">
      <h2>📝 Notas de Blog TDAH</h2>
      <div id="blog-content">
        <p>Cargando artículos sobre TDAH...</p>
        </div>
      <button id="refresh-blog-btn">🔄 Actualizar Artículos</button>
    </section>

    <section id="nutricion" class="seccion">
        <h2>🍎 Nutrición y Recetas</h2>
        <div id="nutricion-content">
            <p>Cargando recomendaciones nutricionales y recetas...</p>
            </div>
        <button id="refresh-nutricion-btn">🔄 Actualizar Contenido</button>
    </section>

    <section id="config" class="seccion">
      <h2>⚙️ Configuración</h2>
      
      <div class="config-card" id="config-card">
        <h3>🔗 Conectar con Trello</h3>
        
        <div class="config-step">
          <label for="api-key">API Key de Trello:</label>
          <input type="text" id="api-key" placeholder="Pega aquí tu API Key...">
          <div class="help-text">
            📝 Obtén tu API Key en: <a href="https://trello.com/app-key" target="_blank">https://trello.com/app-key</a>
          </div>
        </div>

        <div class="config-step">
          <label for="token">Token de Trello:</label>
          <input type="text" id="token" placeholder="Pega aquí tu Token...">
          <div class="help-text">
            📝 Genera tu Token clickeando en el link que aparece junto a tu API Key
          </div>
        </div>

        <div class="config-step">
          <label for="board-id">ID del Board:</label>
          <input type="text" id="board-id" placeholder="ID de tu board de Trello...">
          <div class="help-text">
            📝 Encuentra el ID en la URL de tu board: trello.com/b/<strong>ID_AQUI</strong>/nombre-board
          </div>
        </div>

        <button id="test-trello-btn">🔍 Probar Conexión</button>
        <button id="save-trello-config-btn">💾 Guardar Configuración</button>
        
        <div class="success-message" id="trello-success-message">
          ✅ ¡Conexión exitosa! Ya puedes ver tus tareas de Trello.
        </div>
      </div>

      <div class="config-card">
        <h3>📊 Estado de la App</h3>
        <p><strong>Tareas guardadas:</strong> <span id="tasks-count">0</span></p>
        <p><strong>Checklist items:</strong> <span id="checklist-count">0</span></p>
        <p><strong>Última sincronización Trello:</strong> <span id="last-sync">Nunca</span></p>
        
        <button id="clear-data-btn" style="background: #ef4444;">🗑️ Limpiar Todos los Datos</button>
      </div>
    </section>
  </div>

  <div id="temp-message-container"></div>
  <audio id="sound-complete" src="sounds/complete.mp3" preload="auto"></audio>
  <audio id="sound-break" src="sounds/break.mp3" preload="auto"></audio>
  <audio id="sound-task-done" src="sounds/task-done.mp3" preload="auto"></audio>

  <!-- Script de inicialización de Firebase y autenticación -->
  <!-- Este script se ejecuta después de que los SDK de Firebase se han cargado (en el head) -->
  <!-- y antes de main.js, asegurando que 'firebase' esté definido. -->
  <script>
    console.log("Script inline en body: Iniciando configuración de Firebase.");
    // Configuración de Firebase proporcionada por el usuario
    // ¡IMPORTANTE! Reemplaza estos valores con los de TU proyecto de Firebase
    // Encuéntralos en la Consola de Firebase > Configuración del proyecto > Tus apps (aplicación web)
    const firebaseConfig = {
        apiKey: "AIzaSyAaC7FvY_9bDHBvl36YWAIIO9qXyvqZrUw", // <--- VERIFICA ESTE VALOR
        authDomain: "tdah-app-efca9.firebaseapp.com",    // <--- VERIFICA ESTE VALOR
        projectId: "tdah-app-efca9",                     // <--- VERIFICA ESTE VALOR
        storageBucket: "tdah-app-efca9.firebasestorage.app",
        messagingSenderId: "765424031369",
        appId: "1:765424031369:web:838eca686f68f21daa5858",
        measurementId: "G-QY7X98XZZV"
    };

    // Inicializar Firebase y exponer a window para main.js
    // Usamos las funciones de la API global de Firebase (v8 compat)
    window.firebaseApp = firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore(); // Acceder a Firestore
    window.auth = firebase.auth();   // Acceder a Auth

    // Asegurarse de usar el appId de la configuración de Firebase
    window.appId = firebaseConfig.appId;
    // __initial_auth_token es una variable global proporcionada por el entorno Canvas
    window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    console.log("Script inline en body: Firebase inicializado y variables expuestas.");

    // Funciones globales que main.js también podría necesitar o que el HTML llama directamente
    // Definirlas aquí para asegurar que estén disponibles cuando DOMContentLoaded se dispare.
    window.mostrarSeccion = function(idSeccion) {
        console.log(`Intentando mostrar sección: ${idSeccion}`);
        document.querySelectorAll('.seccion').forEach(seccion => {
            seccion.classList.remove('active');
        });
        document.querySelectorAll('.nav-tabs button').forEach(button => {
            button.classList.remove('active');
        });

        const seccionActiva = document.getElementById(idSeccion);
        if (seccionActiva) {
            seccionActiva.classList.add('active');
            console.log(`Sección ${idSeccion} activada.`);
        } else {
            console.warn(`Sección con ID ${idSeccion} no encontrada.`);
        }
        const botonActivo = document.getElementById(`btn-${idSeccion}`);
        if (botonActivo) {
            botonActivo.classList.add('active');
            console.log(`Botón ${idSeccion} activado.`);
        } else {
            console.warn(`Botón con ID btn-${idSeccion} no encontrado.`);
        }
    };

    window.showTempMessage = function(message, type = 'info', duration = 3000) {
        console.log(`Mostrar mensaje temporal: [${type}] ${message}`);
        const tempMessageContainer = document.getElementById('temp-message-container');
        if (!tempMessageContainer) {
            console.error("Contenedor de mensajes temporales no encontrado.");
            return;
        }
        const msgElement = document.createElement('div');
        msgElement.className = `temp-message ${type}`;
        msgElement.textContent = message;
        tempMessageContainer.appendChild(msgElement);

        msgElement.offsetHeight;
        msgElement.classList.add('show');

        setTimeout(() => {
            msgElement.classList.remove('show');
            msgElement.classList.add('hide');
            msgElement.addEventListener('transitionend', () => msgElement.remove(), { once: true });
        }, duration);
    };


    document.addEventListener('DOMContentLoaded', async () => {
        console.log("DOMContentLoaded: DOM completamente cargado. Iniciando autenticación Firebase...");

        // Referencias a elementos de la UI de autenticación
        const userDisplayName = document.getElementById('user-display-name');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const emailSigninToggleBtn = document.getElementById('email-signin-toggle-btn');
        const anonymousSigninBtn = document.getElementById('anonymous-signin-btn'); // Nuevo botón para anónimo
        const logoutBtn = document.getElementById('logout-btn');
        const emailAuthForm = document.getElementById('email-auth-form');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const emailSignupBtn = document.getElementById('email-signup-btn');
        const emailLoginBtn = document.getElementById('email-login-btn');
        const emailFormCloseBtn = document.getElementById('email-form-close-btn');

        // Referencia al área de información del usuario para control de estilo
        const userInfoArea = document.getElementById('user-info-area');


        // Adjuntar event listeners a los botones de navegación
        document.getElementById('btn-pomodoro').addEventListener('click', () => window.mostrarSeccion('pomodoro'));
        document.getElementById('btn-tareas').addEventListener('click', () => window.mostrarSeccion('tareas'));
        document.getElementById('btn-checklist').addEventListener('click', () => window.mostrarSeccion('checklist'));
        document.getElementById('btn-journal').addEventListener('click', () => window.mostrarSeccion('journal'));
        document.getElementById('btn-notas').addEventListener('click', () => window.mostrarSeccion('notas'));
        document.getElementById('btn-config').addEventListener('click', () => window.mostrarSeccion('config'));
        console.log("DOMContentLoaded: Event listeners de navegación adjuntados.");

        // Manejar la autenticación
        window.auth.onAuthStateChanged(async (user) => {
            console.log("onAuthStateChanged: Estado de autenticación cambiado.");
            if (user) {
                window.currentUserId = user.uid;
                console.log("onAuthStateChanged: Usuario autenticado. UID:", window.currentUserId);

                // Mostrar información del usuario y botón de cerrar sesión
                userDisplayName.textContent = `Bienvenido, ${user.displayName || user.email || user.uid.substring(0, 8)}!`;
                googleSigninBtn.style.display = 'none';
                emailSigninToggleBtn.style.display = 'none';
                anonymousSigninBtn.style.display = 'none'; // Ocultar si ya está logueado
                logoutBtn.style.display = 'inline-block';
                emailAuthForm.style.display = 'none'; // Asegurarse de que el formulario de email esté oculto

                // Estilos para el estado autenticado: alinear a la derecha
                userInfoArea.style.justifyContent = 'flex-end';
                userInfoArea.style.flexDirection = 'row';
                userDisplayName.style.textAlign = 'right';
                // Asegurar márgenes correctos para la disposición en fila
                googleSigninBtn.style.marginRight = '10px';
                emailSigninToggleBtn.style.marginRight = '10px';
                anonymousSigninBtn.style.marginRight = '10px';
                logoutBtn.style.marginLeft = '10px';


                // Una vez autenticado, cargar todos los datos
                if (typeof window.loadAllUserData === 'function') {
                    window.loadAllUserData();
                } else {
                    console.error("loadAllUserData no está definida globalmente.");
                }
            } else {
                console.log("onAuthStateChanged: Usuario no autenticado. Mostrando opciones de inicio de sesión.");
                userDisplayName.textContent = 'Por favor, inicia sesión:';
                googleSigninBtn.style.display = 'inline-block';
                emailSigninToggleBtn.style.display = 'inline-block';
                anonymousSigninBtn.style.display = 'inline-block'; // Mostrar botón para anónimo
                logoutBtn.style.display = 'none';
                emailAuthForm.style.display = 'none'; // Asegurarse de que el formulario de email esté oculto

                // Estilos para el estado no autenticado: centrar botones
                userInfoArea.style.justifyContent = 'center';
                userInfoArea.style.flexDirection = 'column';
                userDisplayName.style.textAlign = 'center';
                // Eliminar márgenes laterales cuando están apilados
                googleSigninBtn.style.marginRight = '0';
                emailSigninToggleBtn.style.marginRight = '0';
                anonymousSigninBtn.style.marginRight = '0';
                logoutBtn.style.marginLeft = '0'; // También remover margen izquierdo del logout si se muestra aquí (aunque no debería)


                // Si el usuario no está autenticado, no intentar signInAnonymously automáticamente
                // El usuario debe hacer clic en "Continuar como Anónimo"
            }
        });

        // Adjuntar event listeners para Google Sign-In y Sign-Out
        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await window.auth.signInWithPopup(provider);
                window.showTempMessage('Inicio de sesión con Google exitoso!', 'success');
            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                window.showTempMessage(`Error al iniciar sesión con Google: ${error.message}`, 'error');
            }
        });

        // Lógica para mostrar/ocultar el formulario de email
        emailSigninToggleBtn.addEventListener('click', () => {
            emailAuthForm.style.display = emailAuthForm.style.display === 'none' ? 'block' : 'none';
        });

        emailFormCloseBtn.addEventListener('click', () => {
            emailAuthForm.style.display = 'none';
            emailInput.value = '';
            passwordInput.value = '';
        });

        // Lógica para registrarse con Email y Contraseña
        emailSignupBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                window.showTempMessage('Por favor, ingresa un correo y una contraseña.', 'warning');
                return;
            }
            if (password.length < 6) {
                window.showTempMessage('La contraseña debe tener al menos 6 caracteres.', 'warning');
                return;
            }

            try {
                await window.auth.createUserWithEmailAndPassword(email, password);
                window.showTempMessage('Registro exitoso! Has iniciado sesión.', 'success');
                emailAuthForm.style.display = 'none'; // Ocultar formulario al registrarse
            } catch (error) {
                console.error("Error al registrarse con Email:", error);
                if (error.code === 'auth/email-already-in-use') {
                    window.showTempMessage('Este correo ya está registrado. Intenta iniciar sesión o usa otro correo.', 'error');
                } else {
                    window.showTempMessage(`Error de registro: ${error.message}`, 'error');
                }
            }
        });

        // Lógica para iniciar sesión con Email y Contraseña
        emailLoginBtn.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;

            if (!email || !password) {
                window.showTempMessage('Por favor, ingresa un correo y una contraseña.', 'warning');
                return;
            }

            try {
                await window.auth.signInWithEmailAndPassword(email, password);
                window.showTempMessage('Inicio de sesión exitoso!', 'success');
                emailAuthForm.style.display = 'none'; // Ocultar formulario al iniciar sesión
            } catch (error) {
                console.error("Error al iniciar sesión con Email:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    window.showTempMessage('Correo o contraseña incorrectos.', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    window.showTempMessage('Formato de correo electrónico inválido.', 'error');
                } else {
                    window.showTempMessage(`Error de inicio de sesión: ${error.message}`, 'error');
                }
            }
        });

        // Lógica para iniciar sesión como anónimo
        anonymousSigninBtn.addEventListener('click', async () => {
            try {
                // Si hay un token inicial (del entorno Canvas), usarlo.
                // De lo contrario, iniciar sesión anónimamente.
                if (window.initialAuthToken) {
                    console.log("anonymousSigninBtn: Usando initialAuthToken.");
                    await window.auth.signInWithCustomToken(window.initialAuthToken);
                } else {
                    console.log("anonymousSigninBtn: Usando signInAnonymously.");
                    await window.auth.signInAnonymously();
                }
                window.showTempMessage('Has iniciado sesión como usuario anónimo.', 'info');
            } catch (error) {
                console.error("Error al iniciar sesión como anónimo:", error);
                window.showTempMessage(`Error al iniciar sesión anónima: ${error.message}`, 'error');
            }
        });


        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                await window.auth.signOut();
                window.showTempMessage('Sesión cerrada.', 'info');
                // Recargar para limpiar el estado y volver a mostrar las opciones de inicio de sesión
                location.reload(); 
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                window.showTempMessage(`Error al cerrar sesión: ${error.message}`, 'error');
            }
        });


        // Inicializar la primera sección visible al cargar la página
        window.mostrarSeccion('pomodoro');
        console.log("DOMContentLoaded: Sección Pomodoro inicializada como activa.");

    });
  </script>

  <!-- main.js se carga al final del body para asegurar que todos los elementos HTML estén disponibles -->
  <script src="js/main.js"></script>
</body>
</html>
