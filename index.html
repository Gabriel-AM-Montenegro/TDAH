<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>App TDAH</title>
  <link rel="stylesheet" href="css/styles1.css">

  <!-- Firebase SDKs: Cargados como scripts tradicionales (SIN type="module") -->
  <!-- Esto los expone globalmente como 'firebase' y sus sub-namespaces -->
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
  <!-- Si usas Analytics, descomenta la l√≠nea de abajo -->
  <!-- <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"></script> -->

  <style>
    /* Estilo para el div de verificaci√≥n de CSS (eliminar cuando se confirme que el CSS carga) */
    #css-check {
      position: fixed;
      top: 0;
      left: 0;
      width: 10px;
      height: 10px;
      background-color: red; /* Si ves rojo, el CSS no carga o hay un problema */
      z-index: 99999;
    }
  </style>
</head>
<body>
  <div id="css-check"></div> <!-- Div para verificar carga de CSS -->

  <div class="container">

    <header>
      <h1>üß† TDAH Helper App</h1>
      <p>Tu asistente personal para organizaci√≥n y productividad</p>
      <!-- user-info-area: Se ajustar√° din√°micamente para centrar los botones cuando no hay sesi√≥n -->
      <div id="user-info-area">
        <span id="user-display-name">Cargando...</span>
        <div class="auth-buttons-wrapper">
          <button id="google-signin-btn" class="auth-btn">Iniciar con Google</button>
          <button id="anonymous-signin-btn" class="auth-btn">Iniciar An√≥nimamente</button>
          <button id="email-signin-toggle-btn" class="auth-btn">Iniciar con Email</button>
        </div>
        <button id="logout-btn" style="display: none;">Cerrar Sesi√≥n</button>
        <!-- ID de usuario para depuraci√≥n y referencia -->
        <p id="user-id-display" style="font-size: 0.8em; color: rgba(255,255,255,0.7); margin-top: 5px;"></p>
      </div>
    </header>

    <nav class="nav-tabs">
      <button id="btn-pomodoro" class="active">‚è±Ô∏è Pomodoro</button>
      <button id="btn-checklist">‚úÖ Checklist R√°pido</button>
      <button id="btn-journal">üìù Journal</button>
      <button id="btn-habitos">üå± H√°bitos</button>
      <button id="btn-tareas">üìã Tareas Trello</button>
      <button id="btn-notas">üìö Notas Blog</button>
      <button id="btn-nutricion">üçé Nutrici√≥n</button>
      <button id="btn-config">‚öôÔ∏è Configuraci√≥n</button>
    </nav>

    <main>
      <!-- Secci√≥n Pomodoro -->
      <section id="pomodoro" class="seccion active">
        <h2>‚è±Ô∏è Temporizador Pomodoro</h2>
        <p class="subtitle">Enf√≥cate en tus tareas con bloques de tiempo definidos.</p>
        <div class="pomodoro-timer-container">
          <svg class="pomodoro-progress-ring" width="200" height="200">
            <circle class="pomodoro-progress-ring-track" stroke="#e6e6e6" stroke-width="10" fill="transparent" r="90" cx="100" cy="100"/>
            <circle class="pomodoro-progress-ring-progress" stroke="var(--primary-color)" stroke-width="10" fill="transparent" r="90" cx="100" cy="100"/>
          </svg>
          <p id="timer">25:00</p>
        </div>
        <div class="pomodoro-buttons">
          <button id="start-timer-btn">Iniciar</button>
          <button id="pause-pomodoro-btn">Pausar</button>
          <button id="reset-timer-btn">Reiniciar</button>
        </div>
        <audio id="sound-complete" src="https://www.soundjay.com/buttons/beep-07.mp3" preload="auto"></audio>
        <audio id="sound-break" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3" preload="auto"></audio>
        <audio id="sound-task-done" src="https://www.soundjay.com/buttons/button-20.mp3" preload="auto"></audio>
      </section>

      <!-- Secci√≥n Checklist R√°pido -->
      <section id="checklist" class="seccion">
        <h2>‚úÖ Checklist R√°pido</h2>
        <p class="subtitle">La clave es no abrumarse. Al inicio de cada d√≠a, identifica las <strong>3 tareas m√°s importantes (MITs - Most Important Tasks)</strong>. Si terminas esas, puedes pasar a otras, pero el objetivo es asegurar lo crucial.</p>
        <div class="mit-explanation">
          <p>Marca hasta 3 tareas como MITs usando la casilla "MIT". Estas se destacar√°n con un color especial. ¬°Puedes a√±adir m√°s tareas en cualquier momento!</p>
        </div>
        <div class="input-group">
          <input type="text" id="checkItem" placeholder="Nuevo √≠tem del checklist..." />
          <button id="add-check-item-btn">‚ûï Agregar</button>
        </div>
        <ul id="checkList">
          <!-- Los √≠tems del checklist se cargar√°n aqu√≠ -->
        </ul>
        <p class="help-text">Para tareas peque√±as y recordatorios r√°pidos del d√≠a</p>
      </section>

      <!-- Secci√≥n Journal Personal -->
      <section id="journal" class="seccion">
        <h2>üìù Journal Personal</h2>
        <p class="subtitle">Un espacio para tus pensamientos, reflexiones y logros diarios.</p>
        <textarea id="journalEntry" placeholder="Escribe aqu√≠ tu entrada de hoy..."></textarea>
        <button id="save-journal-entry-btn">Guardar Entrada</button>
        <h3>Tus Entradas Anteriores</h3>
        <ul id="journalEntriesList">
          <!-- Las entradas del journal se cargar√°n aqu√≠ -->
        </ul>
      </section>

      <!-- Secci√≥n H√°bitos Diarios -->
      <section id="habitos" class="seccion">
        <h2>üå± H√°bitos Diarios</h2>
        <p class="subtitle">Construye rutinas saludables y sigue tu progreso d√≠a a d√≠a.</p>
        <div class="input-group">
          <input type="text" id="newHabitInput" placeholder="A√±adir nuevo h√°bito (ej. Beber 2L de agua)" />
          <button id="add-habit-btn">‚ûï A√±adir H√°bito</button>
        </div>
        <h3>Mis H√°bitos</h3>
        <ul id="habitsList">
          <!-- Los h√°bitos se cargar√°n aqu√≠ -->
        </ul>
      </section>

      <!-- Secci√≥n Tareas Trello -->
      <section id="tareas" class="seccion">
        <h2>üìã Tareas Trello</h2>
        <p class="subtitle">Visualiza las tareas de tu board de Trello que vencen esta semana.</p>
        <div class="config-card">
          <h3>Estado de Conexi√≥n</h3>
          <p id="trello-status" class="status-indicator status-disconnected">‚ùå Trello no conectado</p>
          <p id="trello-success-message" class="success-message" style="display: none;">Conexi√≥n exitosa. ¬°Tareas cargadas!</p>
          <button id="test-trello-btn">Probar Conexi√≥n</button>
          <button id="config-trello-btn">Configurar Trello</button>
        </div>
        <h3>Tareas para esta semana</h3>
        <ul id="listaTareas">
          <li>Cargando tareas de Trello...</li>
        </ul>
      </section>

      <!-- Secci√≥n Notas Blog -->
      <section id="notas" class="seccion">
        <h2>üìö Notas Blog</h2>
        <p class="subtitle">Art√≠culos y consejos √∫tiles sobre TDAH y productividad.</p>
        <button id="refresh-blog-btn">Actualizar Art√≠culos</button>
        <div id="blog-content">
          <p>Cargando art√≠culos...</p>
        </div>
      </section>

      <!-- Secci√≥n Nutrici√≥n -->
      <section id="nutricion" class="seccion">
        <h2>üçé Nutrici√≥n</h2>
        <p class="subtitle">Recomendaciones nutricionales para apoyar tu bienestar cerebral.</p>
        <button id="refresh-nutricion-btn">Actualizar Contenido</button>
        <div id="nutricion-content">
          <p>Cargando recomendaciones...</p>
        </div>
      </section>

      <!-- Secci√≥n Configuraci√≥n -->
      <section id="config" class="seccion">
        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        <p class="subtitle">Personaliza tu experiencia y gestiona tus datos.</p>

        <h3>Configuraci√≥n de Trello API</h3>
        <div class="config-step">
          <label for="api-key">Trello API Key:</label>
          <input type="text" id="api-key" placeholder="Tu clave API de Trello" />
          <p class="help-text">Obt√©n tu API Key <a href="https://trello.com/power-ups/admin" target="_blank">aqu√≠</a>.</p>
        </div>
        <div class="config-step">
          <label for="token">Trello Token:</label>
          <input type="text" id="token" placeholder="Tu token de Trello" />
          <p class="help-text">Genera un token <a href="https://trello.com/power-ups/admin" target="_blank">aqu√≠</a> (haz clic en "Token" bajo tu API Key).</p>
        </div>
        <div class="config-step">
          <label for="board-id">Trello Board ID:</label>
          <input type="text" id="board-id" placeholder="ID de tu tablero de Trello" />
          <p class="help-text">El ID del tablero est√° en la URL: <code>https://trello.com/b/<span style="font-weight: bold; color: var(--primary-color);">[BOARD_ID]</span>/tu-tablero</code></p>
        </div>
        <button id="save-trello-config-btn">Guardar Configuraci√≥n de Trello</button>

        <h3>Gesti√≥n de Datos</h3>
        <button id="clear-data-btn" class="button-danger">Limpiar Todos los Datos</button>
        <p class="help-text">Esto eliminar√° todos tus datos (Pomodoro, Checklist, Journal, Trello Config, H√°bitos) de forma permanente.</p>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 TDAH Helper App. Todos los derechos reservados.</p>
      <div class="status-counts">
        <span>Tareas: <span id="tasks-count">0</span></span>
        <span>Checklist: <span id="checklist-count">0</span></span>
      </div>
    </footer>
  </div>

  <!-- Contenedor para mensajes temporales -->
  <div id="temp-message-container"></div>

  <!-- Contenedor para el confeti -->
  <div id="confetti-container"></div>

  <!-- Custom Confirmation Modal -->
  <div id="custom-modal-overlay" class="custom-modal-overlay">
    <div class="custom-modal-content">
      <p id="custom-modal-message">¬øEst√°s seguro?</p>
      <div class="modal-buttons">
        <button id="custom-modal-yes-btn">S√≠</button>
        <button id="custom-modal-no-btn" class="button-danger">No</button>
      </div>
    </div>
  </div>

  <!-- Welcome Tour Overlay -->
  <div id="welcome-tour-overlay">
    <div class="welcome-tour-modal-inner">
      <div class="welcome-tour-content">
        <h3 id="tour-title"></h3>
        <p id="tour-description"></p>
        <div class="tour-highlight-image-container">
          <img id="tour-highlight-image" src="" alt="Highlight Image" class="tour-highlight-image" style="display: none;">
        </div>
      </div>
      <div class="welcome-tour-navigation">
        <button id="tour-back-btn" class="tour-nav-btn">‚¨ÖÔ∏è Anterior</button>
        <div id="tour-dots" class="tour-dots"></div>
        <button id="tour-next-btn" class="tour-nav-btn">Siguiente ‚û°Ô∏è</button>
        <button id="tour-skip-btn" class="tour-nav-btn button-danger">Omitir Tour</button>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    // Exponer variables globales para que main.js pueda acceder a ellas
    // Estas variables son proporcionadas por el entorno de Canvas.
    window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // ** Inicializaci√≥n de Firebase aqu√≠ **
    // Aseg√∫rate de que firebaseConfig tenga projectId
    if (!window.firebaseConfig || !window.firebaseConfig.projectId) {
        console.error("Firebase: projectId no encontrado en __firebase_config. Aseg√∫rate de que la variable de entorno est√© configurada correctamente.");
        document.addEventListener('DOMContentLoaded', () => {
            const authButtons = document.querySelector('.auth-buttons-wrapper');
            if (authButtons) {
                authButtons.innerHTML = '<p style="color: var(--error-dark); font-weight: bold;">Error: Configuraci√≥n de Firebase incompleta.</p>';
            }
        });
        // Detener la ejecuci√≥n si la configuraci√≥n es inv√°lida
        // throw new Error("Firebase configuration error: projectId not provided."); 
    }

    // Inicializar Firebase App y servicios
    // Las funciones de Firebase ahora est√°n disponibles globalmente (firebase.initializeApp, firebase.firestore, firebase.auth)
    window.app = firebase.initializeApp(window.firebaseConfig);
    window.db = firebase.firestore(); // Firebase SDK v8: firebase.firestore() sin window.app como argumento
    window.auth = firebase.auth();   // Firebase SDK v8: firebase.auth() sin window.app como argumento

    // Bandera para controlar el estado de cierre de sesi√≥n
    window.isLoggingOut = false;

    // Listener de estado de autenticaci√≥n (aqu√≠ en index.html)
    firebase.auth().onAuthStateChanged(async (user) => {
        console.log("onAuthStateChanged (index.html): Estado de autenticaci√≥n cambiado. User:", user ? user.uid : "null");

        const userDisplayNameElement = document.getElementById('user-display-name');
        const logoutBtn = document.getElementById('logout-btn');
        const authButtonsWrapper = document.querySelector('.auth-buttons-wrapper');
        const userIdDisplay = document.getElementById('user-id-display');
        const userInfoArea = document.getElementById('user-info-area');

        if (user) {
            window.currentUserId = user.uid;
            console.log("onAuthStateChanged (index.html): Usuario autenticado. UID:", window.currentUserId);

            if (userDisplayNameElement) userDisplayNameElement.textContent = `Bienvenido, ${user.displayName || user.email || user.uid.substring(0, 8)}!`;
            if (userIdDisplay) userIdDisplay.textContent = `ID de Usuario: ${user.uid}`;
            if (authButtonsWrapper) authButtonsWrapper.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'inline-block';
            if (userInfoArea) userInfoArea.classList.remove('auth-options-visible');

            // Solo cargar datos si no estamos en proceso de cierre de sesi√≥n
            if (typeof window.loadAllUserData === 'function' && !window.isLoggingOut) {
                await window.loadAllUserData();
            } else if (window.isLoggingOut) {
                console.log("onAuthStateChanged (index.html): Usuario reautenticado despu√©s de un cierre de sesi√≥n expl√≠cito. Reiniciando isLoggingOut.");
                window.isLoggingOut = false;
                if (typeof window.loadAllUserData === 'function') {
                    await window.loadAllUserData();
                }
            }

        } else { // Usuario es null (no autenticado)
            window.currentUserId = null;
            console.log("onAuthStateChanged (index.html): Usuario no autenticado.");
            if (userDisplayNameElement) userDisplayNameElement.textContent = 'Por favor, inicia sesi√≥n:';
            if (userIdDisplay) userIdDisplay.textContent = '';
            if (authButtonsWrapper) authButtonsWrapper.style.display = 'flex';
            if (logoutBtn) logoutBtn.style.display = 'none';
            if (userInfoArea) userInfoArea.classList.add('auth-options-visible');

            // Intentar autenticar con token inicial o an√≥nimamente si no estamos cerrando sesi√≥n
            if (window.initialAuthToken && !window.isLoggingOut) {
                try {
                    console.log("onAuthStateChanged (index.html): Intentando signInWithCustomToken con initialAuthToken.");
                    await firebase.auth().signInWithCustomToken(window.initialAuthToken);
                    console.log("onAuthStateChanged (index.html): signInWithCustomToken exitoso.");
                } catch (error) {
                    console.error("onAuthStateChanged (index.html): Error al iniciar sesi√≥n con CustomToken:", error);
                    window.showTempMessage(`Error de autenticaci√≥n inicial: ${error.message}`, 'error');
                }
            } else if (!window.isLoggingOut) {
                try {
                    console.log("onAuthStateChanged (index.html): No hay token inicial, intentando signInAnonymously.");
                    await firebase.auth().signInAnonymously();
                    console.log("onAuthStateChanged (index.html): signInAnonymously exitoso.");
                } catch (error) {
                    console.error("onAuthStateChanged (index.html): Error al iniciar sesi√≥n an√≥nima:", error);
                    window.showTempMessage(`Error al iniciar sesi√≥n an√≥nima: ${error.message}`, 'error');
                }
            } else if (window.isLoggingOut) {
                window.isLoggingOut = false;
                console.log("onAuthStateChanged (index.html): Cierre de sesi√≥n expl√≠cito completado. Mostrando opciones de autenticaci√≥n.");
            }
        }
    });


    // Funci√≥n para mostrar/ocultar secciones
    window.mostrarSeccion = function(idSeccion) {
      // Asegurarse de que los elementos existan antes de intentar acceder a ellos
      const targetSection = document.getElementById(idSeccion);
      if (!targetSection) {
        console.error(`Error: La secci√≥n con ID '${idSeccion}' no fue encontrada en el DOM.`);
        return;
      }

      document.querySelectorAll('.seccion').forEach(seccion => {
        seccion.classList.remove('active');
      });
      targetSection.classList.add('active');

      // Actualizar el estado de los botones de navegaci√≥n
      document.querySelectorAll('.nav-tabs button').forEach(button => {
        button.classList.remove('active');
      });
      const navButton = document.getElementById(`btn-${idSeccion}`);
      if (navButton) {
        navButton.classList.add('active');
      } else {
        console.warn(`Bot√≥n de navegaci√≥n para la secci√≥n '${idSeccion}' no encontrado.`);
      }

      // Actualizar el t√≠tulo de la p√°gina
      document.title = `App TDAH - ${idSeccion.charAt(0).toUpperCase() + idSeccion.slice(1)}`;
    };

    // Funci√≥n para disparar confeti
    window.triggerConfetti = function() {
        const confettiContainer = document.getElementById('confetti-container');
        if (!confettiContainer) return;

        const colors = ['#4F46E5', '#7C3AED', '#FFD700', '#FF69B4', '#00FFFF'];
        for (let i = 0; i < 50; i++) {
            const piece = document.createElement('div');
            piece.classList.add('confetti-piece');
            piece.style.left = Math.random() * 100 + 'vw';
            piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            piece.style.animationDuration = Math.random() * 3 + 2 + 's'; // 2 to 5 seconds
            piece.style.animationDelay = Math.random() * 0.5 + 's';
            piece.style.transform = `translateY(-${Math.random() * 20}px) rotateZ(${Math.random() * 360}deg)`;
            confettiContainer.appendChild(piece);

            // Eliminar la pieza despu√©s de que termine la animaci√≥n
            piece.addEventListener('animationend', () => {
                piece.remove();
            });
        }
    };

    // Funci√≥n para mostrar mensajes temporales
    window.showTempMessage = function(message, type = 'info', duration = 3000) {
        const container = document.getElementById('temp-message-container');
        if (!container) {
            console.warn('Contenedor de mensajes temporales no encontrado. Mensaje:', message);
            return;
        }

        const messageDiv = document.createElement('div');
        messageDiv.classList.add('temp-message', type);
        messageDiv.textContent = message;
        container.appendChild(messageDiv);

        // Forzar reflow para que la transici√≥n de opacidad funcione
        void messageDiv.offsetWidth;
        messageDiv.classList.add('show');

        setTimeout(() => {
            messageDiv.classList.remove('show');
            messageDiv.classList.add('hide'); // Iniciar la transici√≥n de ocultamiento
            messageDiv.addEventListener('transitionend', () => {
                messageDiv.remove();
            }, { once: true });
        }, duration);
    };

    // Funci√≥n para el modal de confirmaci√≥n personalizado
    window.showCustomConfirm = function(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('custom-modal-overlay');
            const messageEl = document.getElementById('custom-modal-message');
            const yesBtn = document.getElementById('custom-modal-yes-btn');
            const noBtn = document.getElementById('custom-modal-no-btn');

            if (!modal || !messageEl || !yesBtn || !noBtn) {
                console.error("Elementos del modal de confirmaci√≥n no encontrados. Usando confirm() por defecto.");
                resolve(confirm(message));
                return;
            }

            messageEl.textContent = message;
            modal.style.display = 'flex'; // Make it visible (but still transparent/offset)

            // Force reflow to ensure display:flex is applied before adding 'show' class
            // This is crucial for CSS transitions to work from display:none to display:flex
            void modal.offsetWidth; 

            modal.classList.add('show'); // Now add the class that applies opacity and transform

            const cleanup = () => {
                modal.classList.remove('show'); // Start hide transition
                // Wait for the transition to finish before setting display to 'none'
                modal.addEventListener('transitionend', () => {
                    modal.style.display = 'none';
                }, { once: true });
                yesBtn.removeEventListener('click', onYesClick);
                noBtn.removeEventListener('click', onNoClick);
            };

            const onYesClick = () => {
                cleanup();
                resolve(true);
            };

            const onNoClick = () => {
                cleanup();
                resolve(false);
            };

            yesBtn.addEventListener('click', onYesClick);
            noBtn.addEventListener('click', onNoClick);
        });
    };
  </script>

  <!-- main.js se carga al final del body para asegurar que todos los elementos HTML est√©n disponibles -->
  <!-- Importante: main.js NO debe ser un m√≥dulo si Firebase se carga globalmente -->
  <script src="js/main.js"></script>
</body>
</html>